# Penetration Testing Process

### Table of Contents
- [Pre-Engagement](#1-pre-engagement)
- [Information Gathering](#2-information-gathering)
	- [Network Enumeration with Nmap](#network-enumeration-with-nmap)

### Tips
- Strong knowledge of basics to provide value fast
- Build my own methodology
- Ethical and legal considerations are crucial, OSINT and info gathering are OK (provided sources are public),
scanning is not
- Reinforce skills with bug bounty work
- Always get a copy of the signed scope of work/contract and a formal doc listing the scope of testing (URLs,
IP addresses, CIDR network ranges, wireless SSIDs, facilities for physical assessments, lists of emails and
phone numbers for social engineering engagements) signed by the client!
- If additional items are added to the scope get it in writing!
- Do no harm, always get written consent when performing any actions that may impact the client's network or
services
- Document, document, document
- When in doubt document and overcommunicate
- After this path specialize in one subject while continuing to build skills in all areas to become as 
well-rounded as possible

![Penetration testing process](./img/pentest-process.png)

## 1. Pre-Engagement

Commitments, tasks, scope, limitations and related agreements are documented. Contracts are drawn up and 
essential information is exchanged.

## 2. Information Gathering

Gather information on the target(s) through scanning, walking the application, OSINT, etc.

**Notes**

- Keep detailed notes and be thorough when gathering information, don't skip steps and jump to attempting 
exploitation!
- Patience and organization are critical.
- Enumeration is key
- Manual enumeration is critical

### Network Enumeration with Nmap

#### Host Discovery

Nmap documentation on host scanning - https://nmap.org/book/host-discovery-strategies.html

Scan a network range:

`sudo nmap 10.129.2.0/24 -sn -oA tnet | grep for | cut -d" " -f5`

- `-sn` disables port scanning and automatically ping scans with ICMP echo requests (`-PE`)

Scan a list of hosts:

`sudo nmap -sn -oA tnet -iL hosts.txt | grep for | cut -d" " -f5`

Scan multiple IPs:

`sudo nmap -sn -oA tnet 10.129.2.18 10.129.2.19 10.129.2.20 | grep for | cut -d" " -f5`

Scan a range of IPs:

`sudo nmap -sn -oA tnet 10.129.2.18-20 | grep for | cut -d" " -f5`

Scan a single IP:

`sudo nmap -sn -oA tnet 10.129.2.18 | grep for | cut -d" " -f5`

Use `--packet-trace` to see the packets sent and received

`sudo nmap 10.129.2.18 -sn -oA host -PE --packet-trace`

Use `--reason` to display the reason for the scan result

`sudo nmap 10.129.2.18 -sn -oA host -PE --reason`

We can use the ICMP response TTL to determine the OS of the target, article [here](https://gbhackers.com/operating-systems-can-be-detected-using-ping-command/)

#### Host and Port Scanning

Six states of a scanned port:

| State | Description |
|-------|-------------|
| open | A connection to the port has been established (TCP connections, UDP datagrams, SCTP associations) |
| closed | The packet received contained an RST flag (TCP) |
| filtered | No response received or an error code from the target |
| unfiltered | Only occurs in TCP-ACK scans, means the port is accessible but cannot determine if it is open or closed|
| open\|filtered | If we receive no response, indicates port may be protected by a packet filter or firewall |
| closed\|filtered | Only occurs in IP ID idle scans, indicates it was impossible to determine if the port is closed or filtered by a firewall |

##### Discovering open TCP ports

Scanning top 10 TCP ports:

`sudo nmap 10.129.2.80 --top-ports=10`

- `--top-ports=n` scan top n ports

Trace the packets on a closed port:

`sudo nmap 10.129.2.80 -p 21 --packet-trace -Pn -n --disable-arp-ping`

Use the following for a clear view of the SYN scan:

- `-Pn` disables ICMP echo requests
- `-n` disables DNS resolution
- `--disable-arp-ping` disables...arp ping!!!

| Flag | Full name |
|------|-----------|
| S | SYN |
| A | ACK |
| R | RST |

Closed packet trace:
```
$ sudo nmap 10.129.2.80 -p 21 --packet-trace -Pn -n --disable-arp-ping

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-01 15:40 IST
SENT (0.0464s) TCP 10.10.16.30:64446 > 10.129.2.80:21 S ttl=44 id=45731 iplen=44  seq=1557065458 win=1024 <mss 1460>
RCVD (0.0709s) TCP 10.129.2.80:21 > 10.10.16.30:64446 RA ttl=63 id=0 iplen=40  seq=0 win=0 
Nmap scan report for 10.129.2.80
Host is up (0.025s latency).

PORT   STATE  SERVICE
21/tcp closed ftp

Nmap done: 1 IP address (1 host up) scanned in 0.11 seconds
```

Open packet trace:
```
$ sudo nmap 10.129.2.80 -p 22 --packet-trace -Pn -n --disable-arp-ping

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-01 15:45 IST
SENT (0.0310s) TCP 10.10.16.30:45546 > 10.129.2.80:22 S ttl=49 id=19792 iplen=44  seq=1745403367 win=1024 <mss 1460>
RCVD (0.0588s) TCP 10.129.2.80:22 > 10.10.16.30:45546 SA ttl=63 id=0 iplen=44  seq=2781844885 win=64240 <mss 1338>
Nmap scan report for 10.129.2.80
Host is up (0.028s latency).

PORT   STATE SERVICE
22/tcp open  ssh

Nmap done: 1 IP address (1 host up) scanned in 0.09 seconds
```

Connect scan:

TCP connect scan `-sT`, uses TCP three-way handshake

- The most accurate and stealthy way to determine a port's state, and more polite as it leaves no unfinished 
connections
- Less likely to be detected by IDS or IPS
- Can bypass firewalls that drop incoming but allow outgoing packets
- Takes longer

```
$ sudo nmap -sT 10.129.2.80 -p 445 --packet-trace -Pn -n --disable-arp-ping --reason

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-01 16:00 IST
CONN (0.0165s) TCP localhost > 10.129.2.80:445 => Operation now in progress
CONN (0.0433s) TCP localhost > 10.129.2.80:445 => Connected
Nmap scan report for 10.129.2.80
Host is up, received user-set (0.027s latency).

PORT    STATE SERVICE      REASON
445/tcp open  microsoft-ds syn-ack

Nmap done: 1 IP address (1 host up) scanned in 0.04 seconds
```

##### Filtered Ports
