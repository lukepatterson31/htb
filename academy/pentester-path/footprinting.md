# Footprinting

### Table of Contents
- [Enumeration Prinicples](#enumeration-principles)
- [Enumeration Methodology](#enumeration-methodology)
    - [Layer 1: Internet Presence](#layer-1-internet-presence)
    - [Layer 2: Gateway](#layer-2-gateway)
    - [Layer 3: Accessible Services](#layer-3-accessible-services)
    - [Layer 4: Processes](#layer-4-processes)
    - [Layer 5: Privileges](#layer-5-privileges)
    - [Layer 6: OS Setup](#layer-6-os-setup)

**Infrastructure Based Enumeration:**

- [Enumeration Methodology in Practice](#enumeration-methodology-in-practice)
- [Domain Information](#domain-information)
    - [Online Presence](#online-presence)
    - [Certificate Transparency](#certificate-transparency)
    - [Company Hosted Servers](#company-hosted-servers)
    - [Shodan - IP List](#shodan---ip-list)
    - [DNS Records](#dns-records)
- [Cloud Resources](#cloud-resources)
- [Staff](#staff)

**Host Based Enumeration:**

- [FTP](#ftp)
    - [TFTP](#tftp)
    - [Default Configuration](#default-configuration---vsftpd)
    - [Footprinting the Service](#footprinting-the-service---ftp)
- [SMB](#smb)
    - [Samba](#samba)
    - [Default Configuration](#default-configuration---samba)
    - [Dangerous Settings](#dangerous-settings)
    - [Example Share](#example-share)
    - [Footprinting the Service](#footprinting-the-service---smb)
    - [RPCclient](#rpcclient)


### Enumeration Principles

Use passive and active enumeration to gather information from various sources (IPs, domains 
accessible services etc.)

- How is the company structured
- What services does it use
- What third-party vendors does it use
- What security measures may be in place
- How is the infrastructure set up
- How do they provide the services they offer

**The goal is not to get at the systems but to find all ways to get there**

Questions to answer when enumerating:

- What can we see?
- What reasons can we have for seeing it?
- What image does what we see create for us?
- What do we gain from it?
- How can we use it?
- What can we not see?
- What reasons can there be that we do not see?
- What image results for us from what we do not see?

**The Enumeration Principles**

1. There is more than meets the eye. Consider all points of view
2. Distinguish between what we see and what we do not see
3. There are always ways to gain more information. Understand the target

### Enumeration Methodology

The enumeration process is divided into three levels:

1. Infrastructure-based enumeration
2. Host-based enumeration
3. OS-based enumeration

![Enumeration Methodology](./img/enum-method.png)

And six layers:

| Layer | Description | Information Categories | Level |
|-------|-------------|------------------------|-------|
|1. Internet Presence | Identification of internet presence and externally accessible infrastructure. | Domains, Subdomains, vHosts, ASN, Netblocks, IP Addresses, Cloud Instances, Security Measures | Infrastructure |
|2. Gateway | Identify the possible security measures to protect the company's external and internal infrastructure. | Firewalls, DMZ, IPS/IDS, EDR, Proxies, NAC, Network Segmentation, VPN, Cloudflare | Infrastructure |
|3. Accessible Services | Identify accessible interfaces and services that are hosted externally or internally. | Service Type, Functionality, Configuration, Port, Version, Interface | Host |
|4. Processes | Identify the internal processes, sources, and destinations associated with the services. | PID, Processed Data, Tasks, Source, Destination | Host |
|5. Privileges | Identification of the internal permissions and privileges to the accessible services. | Groups, Users, Permissions, Restrictions, Environment | OS |
|6. OS Setup | Identification of the internal components and systems setup. | OS Type, Patch Level, Network config, OS Environment, Configuration files, sensitive private files | OS |

**OSINT sits within the Internet Presence layer**

#### Layer 1: Internet Presence

The "Internet Presence" layer is where we focus on finding the targets we can investigate. If the 
scope in the contract allows us to look for additional hosts, this layer is even more critical than 
for fixed targets only. In this layer, we use different techniques to find domains, subdomains, 
netblocks, and many other components and information that present the presence of the company and 
its infrastructure on the Internet.

**The goal of this layer is to identify all possible target systems and interfaces that can be tested.**

#### Layer 2: Gateway

Here we try to understand the interface of the reachable target, how it is protected, and where it 
is located in the network.

TODO: Link to other modules going into more detail

**The goal is to understand what we are dealing with and what we have to watch out for.**

#### Layer 3: Accessible Services

In the case of accessible services, we examine each destination for all the services it offers. 
Each of these services has a specific purpose that has been installed for a particular reason by 
the administrator. Each service has certain functions, which therefore also lead to specific 
results. To work effectively with them, we need to know how they work. Otherwise, we need to learn 
to understand them.

**This layer aims to understand the reason and functionality of the target system and gain the necessary knowledge to communicate with it and exploit it for our purposes effectively.**

#### Layer 4: Processes

Every time a command or function is executed, data is processed, whether entered by the user or 
generated by the system. This starts a process that has to perform specific tasks, and such tasks 
have at least one source and one target.

**The goal here is to understand these factors and identify the dependencies between them.**

#### Layer 5: Privileges

Each service runs through a specific user in a particular group with permissions and privileges 
defined by the administrator or the system. These privileges often provide us with functions that 
administrators overlook. This often happens in Active Directory infrastructures and many other 
case-specific administration environments and servers where users are responsible for multiple 
administration areas.

**It is crucial to identify these and understand what is and is not possible with these privileges.**

#### Layer 6: OS Setup

Here we collect information about the actual operating system and its setup using internal access. 
This gives us a good overview of the internal security of the systems and reflects the skills and 
capabilities of the company's administrative teams.

**The goal here is to see how the administrators manage the systems and what sensitive internal information we can glean from them.**

### Enumeration Methodology in Practice

A methodology summarizes all systematic procedures in obtaining knowledge within the bounds of a 
given objective. It is important to note that a methodology is not a step-by-step guide but, as the 
definition implies, a summary of systematic procedures. In our case, the enumeration methodology is 
the systematic approach to explore a given target

### Domain Information

- Gather Domain Information passively through OSINT and third party services
- Investigate the company website and determine what services they offer
- Idenitfy technologies used to offer those services
- Familiarize ourself with the services
- Try to look at the services from a developer's point of view to gain technical insight into their 
functionality

#### Online Presence

- Look at SSL Certificates to find domains and subdomains
- Use crt.sh to find more subdomains ([Certificate transparency logs](https://en.wikipedia.org/wiki/Certificate_Transparency))
- Identify the hosts directly accessible from the internet and not hosted by third-party providers
(we may not test those hosts unless we have explicit permission of the third-party provider)

#### Certificate Transparency

Fetch logs for a domain:

```bash
domain="google.com"
curl -s "https://crt.sh/?q=$domain&output=json" | jq .
```

Filter them by unique subdomain:

```bash
domain="google.com"
curl -s "https://crt.sh/?q=$domain&output=json" | jq . | grep name | cut -d":" -f2 | grep -v "CN=" | cut -d'"' -f2 | awk '{gsub(/\\n/,"\n");}1;' | sort -u
```

#### Company Hosted Servers

Find company hosted servers:

```bash
for i in $(cat subdomainlist);do host $i | grep "has address" | grep $domain | cut -d" " -f1,4;done
```

#### Shodan - IP List

Find company hosted servers then run their IPs through Shodan:

```bash
for i in $(cat subdomainlist);do host $i | grep "has address" | grep $domain | cut -d" " -f4 >> ip-addresses.txt;done &&
for i in $(cat ip-addresses.txt);do shodan host $i;done
```

#### DNS Records

Get DNS records for a domain:

```bash
dig any $domain

# If any returns no results use the types one by one
type=("A" "MX" "NS" "TXT" "SOA")
for i in type;do dig $i $domain;done
```

- A records: More IP addresses
- MX records: Who/what manages company emails
- NS records: Name servers, identifying hosting provider
- TXT records: Third-party provider identification, [SPF](https://datatracker.ietf.org/doc/html/rfc7208), [DMARC](https://datatracker.ietf.org/doc/html/rfc7489) and [DKIM](https://datatracker.ietf.org/doc/html/rfc6376), MS values


### Cloud Resources

Use google dorking to find files in AWS S3 buckets and Azure blob storage

```
# S3 bucket
intext:<test-to-find> inurl:amazonaws.com

# Azure blob storage
intext:<test-to-find> inurl:blob.core.windows.net
```

Look at web page source code to find S3 buckets and Azure blob storage too

[Domain.Glass](https://domain.glass/) provides useful information on a company's infrastructure, 
including Cloudflare security assessments

[GrayHatWarfare](https://buckets.grayhatwarfare.com/) can be used to discover AWS, Azure and GCP 
could storage and filter and sort the contents

Look for sensitive files like ssh keys, certs, files containing passwords

### Staff

- Identify staff members on social media (LinkedIn, Xing)
- Look at job postings for information on the company's infrastructure
- Look at staff member's GitHub projects to see what they skills they showcase as they will likely 
use them at the company
- Look for technical employees on LinkedIn (development, security)

### FTP

One of the oldest protocols on the Internet  
Runs on the application layer of the TCP/IP stack  

- port 21 Control channel
- port 20 Data channel
- active or passive mode

Not all commands are implemented on FTP servers, when a command is executed on the client the 
server responds with a status code
[Status codes](https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes)

#### TFTP

Does not provide authentication
Uses UDP instead of TCP
Relies on the file's read and write permissions to limit access
Does not have directory listing functionality

| Commands | Description |
|----------|-------------|
| connect | Sets the remote host and optionally the port for file transfers |
| get | Transfers a file or set of files from the remote host to the local host |
| put | Transfers a file or set of files from the local host to the remote host |
| quit | Quits |
| status | shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out values, etc. |
| verbose | Turns verbose mode on or off |

#### Default Configuration - vsFTPd

Most common ftp server is [vsFTPd](https://security.appspot.com/vsftpd.html) (pureFTP most common on shodan)
Not all settings are in the .conf file, [list here](http://vsftpd.beasts.org/vsftpd_conf.html)

**vsFTPd Config File**

```bash
# List active (uncommented) settings
cat /etc/vsftpd.conf | grep -v "#"
```

**FTPUSERS**

List of users denied access to the FTP service

```bash
cat /etc/ftpusers
```

**Dangerous Settings**

| Setting | Description |
|---------|-------------|
| anonymous_enable=YES | Allowing anonymous login? |
| anon_upload_enable=YES | Allowing anonymous to upload files? |
| anon_mkdir_write_enable=YES | Allowing anonymous to create new directories? |
| no_anon_password=YES | Do not ask anonymous for password? |
| anon_root=/home/username/ftp | Directory for anonymous. |
| write_enable=YES | Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE? |

**Anonymous Login**

Use username `anonymous` for anonymous access if it's enabled

**vsFTPd Status**

Show server status

```bash
ftp> status
```

**vsFTPd Detailed Output**

Use debug and trace for detailed information

```bash
ftp> debug

Debugging on (debug=1).


ftp> trace

Packet tracing on.


```

| Setting | Description |
|---------|-------------|
| dirmessage_enable=YES | Show a message when they first enter a new directory? |
| chown_uploads=YES | Change ownership of anonymously uploaded files? |
| chown_username=username | User who is given ownership of anonymously uploaded files. |
| local_enable=YES | Enable local users to login? |
| chroot_local_user=YES | Place local users into their home directory? |
| chroot_list_enable=YES | Use a list of local users that will be placed in their home directory? |


| Setting | Description |
|---------|-------------|
| hide_ids=YES | All user and group information in directory listings will be displayed as "ftp". |
| ls_recurse_enable=YES | Allows the use of recurse listings. |

**Hiding IDs - YES**

This setting is a security feature to prevent local usernames from being revealed. While usage of
[fail2ban](https://en.wikipedia.org/wiki/Fail2ban) solutions prevents us using these for a brute force attack it can still be useful information

**Recursive Listing**

```bash
ftp> ls -R
```

**Download a file**

```bash
ftp> get Notes.txt
```

**Download all available files**

```bash
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.2
```

**Upload a file**

```bash
ftp> put test.txt
```

#### Footprinting the Service - FTP

**Nmap FTP Scripts**

Find FTP scripts:

```bash
locate scripts/ftp
find / -type f -name ftp* 2>/dev/null | grep scripts
```

Script scan (Aggressive):

```bash
nmap -sV -sC -A -p21 10.10.10.1

# With script packet trace
nmap -sV -sC -A -p21 10.10.10.1 --script-trace
```

Service interaction:

```bash
nc -nv 10.10.10.1 21

telnet 10.10.10.1 21

# Use openssl for servers running TLS/SSL (also gives us the SSL cert)
openssl s_client -connect 10.10.10.1:21 -starttls ftp
```

### SMB

Client-server protocol regulating access to files, directories and other network resources  
TCP protocol used to establish initial connection and the transportation of data ([info](https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-SMB2/%5bMS-SMB2%5d.pdf#%5B%7B%22num%22%3A920%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C69%2C738%2C0%5D))  
Access rights are defined by Access Control Lists (ACL)  
**ACLs are defined based on the shares not the rights assigned locally on the server**

- ports 137, 138, 139 (NetBIOS)
- port 445 (SMB/CIFS)

#### Samba

Developed for Unix-based OS  
Implements Common Internet File System (CIFS)  
[CIFS](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cifs/934c2faa-54af-4526-ac74-6a24d126724e) is a very specific implementation of the SMB protocol  

| SMB Version | Supported | Features |
|-------------|-----------|----------|
| CIFS | Windows NT 4.0 | Communication via NetBIOS interface |
| SMB 1.0 | Windows 2000 | Direct connection via TCP |
| SMB 2.0 | Windows Vista, Windows Server 2008 | Performance upgrades, improved message signing, caching feature |
| SMB 2.1 | Windows 7, Windows Server 2008 R2 | Locking mechanisms |
| SMB 3.0 | Windows 8, Windows Server 2012 | Multichannel connections, end-to-end encryption, remote storage access |
| SMB 3.0.2 | Windows 8.1, Windows Server 2012 R2 |  |
| SMB 3.1.1 | Windows 10, Windows Server 2016 | Integrity checking, AES-128 encryption |

In version 3 Samba server gained the ability to be a full member of an Active Directory domain.  
In version 4, Samba provides an Active Directory domain controller.  
[SMB server daemon](https://www.samba.org/samba/docs/current/man-html/smbd.8.html) (`smbd`) provides filesharing and printing services to clients  
[NetBIOS message block daemon](https://www.samba.org/samba/docs/current/man-html/nmbd.8.html) (`nmbd`) provides NetBIOS over IP naming services to clients  

Workgroups are group names that identify an arbitrary collection of computers and their resources 
on an SMB network. Machines need a name in a NetBIOS environment, which is done through the name 
registration procedure. Either each host reserves it's hostname on the network or the NetBIOS Name 
Server (NBNS) is used to assign them (Windows implementation of NBNS is [WINS](https://networkencyclopedia.com/windows-internet-name-service-wins/))

#### Default Configuration - Samba

Samba offers a wide range of [settings](https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html) that we can define in a text file (`/etc/samba/smb.conf`)

Filtered settings: `cat /etc/samba/smb.conf | grep -v '#\|\;`

Shares are defined with `[share-name]` and contain settings for that share, these settings override 
global settings

Example settings:

| Setting | Description |
|---------|-------------|
| [sharename] | The name of the network share. |
| workgroup = WORKGROUP/DOMAIN | Workgroup that will appear when clients query. |
| path = /path/here/ | The directory to which user is to be given access. |
| server string = STRING | The string that will show up when a connection is initiated. |
| unix password sync = yes | Synchronize the UNIX password with the SMB password? |
| usershare allow guests = yes | Allow non-authenticated users to access defined share? |
| map to guest = bad user | What to do when a user login request doesn't match a valid UNIX user? |
| browseable = yes | Should this share be shown in the list of available shares? |
| guest ok = yes | Allow connecting to the service without using a password? |
| read only = yes | Allow users to read files only? |
| create mask = 0700 | What permissions need to be set for newly created files? |

#### Dangerous Settings

| Setting | Description |
|--------|--------------|
| browseable = yes | Allow listing available shares in the current share? |
| read only = no | Forbid the creation and modification of files? |
| writable = yes | Allow users to create and modify files? |
| guest ok = yes | Allow connecting to the service without using a password? |
| enable privileges = yes | Honor privileges assigned to specific SID? |
| create mask = 0777 | What permissions must be assigned to the newly created files? |
| directory mask = 0777 | What permissions must be assigned to the newly created directories? |
| logon script = script.sh | What script needs to be executed on the user's login? |
| magic script = script.sh | Which script should be executed when the script gets closed? |
| magic output = script.out | Where the output of the magic script needs to be stored? |

#### Example Share

```
...SNIP...

[notes]
	comment = CheckIT
	path = /mnt/notes/

	browseable = yes
	read only = no
	writable = yes
	guest ok = yes

	enable privileges = yes
	create mask = 0777
	directory mask = 0777
```

After adding a share restart samba

`systemctl restart smbd`

#### Footprinting the Service - SMB

Nmap scan targeting SMB and NetBIOS ports

```bash
sudo nmap 10.10.10.2 -sC -sV -p139,445
```

Nmap results are limited so it's a good idea to manually interact with the service 
using other tools like `rpcclient`, which is used to perform MS-RPC functions.

The [Remote Procedure Call](https://www.geeksforgeeks.org/remote-procedure-call-rpc-in-operating-system/) (RPC) is a concept and also a central tool to realize 
operational and work-sharing structures in networks and client-server architectures.
The communication process via RPC includes passing parameters and the return of a 
function value.

```bash
rpcclient -U "" 10.10.10.2
```

#### RPCclient

Example queries that the RPCclient implements (full list in [man page](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html))

| Query | Description |
|-------|-------------|
| srvinfo | Server information. |
| enumdomains | Enumerate all domains that are deployed in the network. |
| querydominfo | Provides domain, server, and user information of deployed domains. |
| netshareenumall | Enumerates all available shares. |
| netsharegetinfo <share> | Provides information about a specific share. |
| enumdomusers | Enumerates all domain users. |
| queryuser <RID> | Provides information about a specific user. |

An anonymous user can access a surprising amount of information using rpcclient if 
anonymous access is enabled, allowing us to discover other users and their groups

Script to gather User & Group RIDs:

```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

Alternatively we can use [Impacket](https://github.com/SecureAuthCorp/impacket)'s [samrdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py)

We can use other toools like [SMBMap](https://github.com/ShawnDEvans/smbmap) and [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) to gather the same information as `rpcclient`

```bash
# TODO crackmapexec and smbmap examples
```
