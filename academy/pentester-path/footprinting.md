# Footprinting

### Table of Contents
- [Enumeration Principles](#enumeration-principles)
- [Enumeration Methodology](#enumeration-methodology)
    - [Layer 1: Internet Presence](#layer-1-internet-presence)
    - [Layer 2: Gateway](#layer-2-gateway)
    - [Layer 3: Accessible Services](#layer-3-accessible-services)
    - [Layer 4: Processes](#layer-4-processes)
    - [Layer 5: Privileges](#layer-5-privileges)
    - [Layer 6: OS Setup](#layer-6-os-setup)

**[Infrastructure Based Enumeration](#infrastructure-based-enumeration):**

- [Enumeration Methodology in Practice](#enumeration-methodology-in-practice)
- [Domain Information](#domain-information)
    - [Online Presence](#online-presence)
    - [Certificate Transparency](#certificate-transparency)
    - [Company Hosted Servers](#company-hosted-servers)
    - [Shodan - IP List](#shodan---ip-list)
    - [DNS Records](#dns-records)
- [Cloud Resources](#cloud-resources)
- [Staff](#staff)

**[Host Based Enumeration](#host-based-enumeration):**

- [FTP](#ftp)
    - [TFTP](#tftp)
    - [Default Configuration](#default-configuration---vsftpd)
    - [Footprinting the Service](#footprinting-the-service---ftp)
- [SMB](#smb)
    - [Samba](#samba)
    - [Default Configuration](#default-configuration---samba)
    - [Dangerous Settings](#dangerous-settings---smb)
    - [Example Share](#example-share)
    - [Footprinting the Service](#footprinting-the-service---smb)
    - [RPCclient](#rpcclient)
    - [Other Tools](#other-tools)
- [NFS](#nfs)
    - [Default Configuration](#default-configuration---nfs)
    - [Dangerous Settings](#dangerous-settings---nfs)
    - [Footprinting the Service](#footprinting-the-service---nfs)
- [DNS](#dns)
    - [Default Configuration](#default-configuration---dns)
    - [Local DNS Configuration](#local-dns-configuration)
    - [Zone Files](#zone-files)
    - [Reverse Name Resolution Files](#reverse-name-resolution-files)
    - [Dangerous Settings](#dangerous-settings---dns)
    - [Footprinting the Service](#footprinting-the-service---dns)
- [SMTP](#smtp)
    - [Default Configuration](#default-configuration---smtp)
    - [Dangerous Settings](#dangerous-settings---smtp)
    - [Footprinting the Service](#footprinting-the-service---smtp)
- [IMAP/POP3](#imappop3)
    - [Default Configuration](#default-configuration---imappop3)
    - [Dangerous Settings](#dangerous-settings---imappop3)
    - [Footprinting the Service](#footprinting-the-service---imappop3)
- [SNMP](#snmp)
    - [Default Configuration](#default-configuration---snmp)
    - [Dangerous Settings](#dangerous-settings---snmp)
    - [Footprinting the Service](#footprinting-the-service---snmp)
- [MySQL](#mysql)
    - [Default Configuration](#default-configuration---mysql)
    - [Dangerous Settings](#dangerous-settings---mysql)
    - [Footprinting the Service](#footprinting-the-service---mysql)
- [MSSQL](#mssql)
    - [MSSQL Clients](#mssql-clients)
    - [MSSQL Databases](#mssql-databases)
    - [Default Configuration](#default-configuration---mssql)
    - [Dangerous Settings](#dangerous-settings---mssql)
    - [Footprinting the Service](#footprinting-the-service---mssql)
- [Oracle TNS](#oracle-tns)
    - [Default Configuration](#default-configuration---oracle-tns)
    - [Footprinting the Service](#footprinting-the-service---oracle-tns)
- [IPMI](#ipmi)
    - [Footprinting the Service](#footprinting-the-service---ipmi)
    - [Dangerous Settings](#dangerous-settings---ipmi)
- [Linux Remote Management Protocols](#linux-remote-management-protocols)
    - [SSH](#ssh)
    


### Enumeration Principles

Use passive and active enumeration to gather information from various sources (IPs, domains 
accessible services etc.)

- How is the company structured
- What services does it use
- What third-party vendors does it use
- What security measures may be in place
- How is the infrastructure set up
- How do they provide the services they offer

**The goal is not to get at the systems but to find all ways to get there**

Questions to answer when enumerating:

- What can we see?
- What reasons can we have for seeing it?
- What image does what we see create for us?
- What do we gain from it?
- How can we use it?
- What can we not see?
- What reasons can there be that we do not see?
- What image results for us from what we do not see?

**The Enumeration Principles**

1. There is more than meets the eye. Consider all points of view
2. Distinguish between what we see and what we do not see
3. There are always ways to gain more information. Understand the target

### Enumeration Methodology

The enumeration process is divided into three levels:

1. Infrastructure-based enumeration
2. Host-based enumeration
3. OS-based enumeration

![Enumeration Methodology](./img/enum-method.png)

And six layers:

| Layer | Description | Information Categories | Level |
|-------|-------------|------------------------|-------|
|1. Internet Presence | Identification of internet presence and externally accessible infrastructure. | Domains, Subdomains, vHosts, ASN, Netblocks, IP Addresses, Cloud Instances, Security Measures | Infrastructure |
|2. Gateway | Identify the possible security measures to protect the company's external and internal infrastructure. | Firewalls, DMZ, IPS/IDS, EDR, Proxies, NAC, Network Segmentation, VPN, Cloudflare | Infrastructure |
|3. Accessible Services | Identify accessible interfaces and services that are hosted externally or internally. | Service Type, Functionality, Configuration, Port, Version, Interface | Host |
|4. Processes | Identify the internal processes, sources, and destinations associated with the services. | PID, Processed Data, Tasks, Source, Destination | Host |
|5. Privileges | Identification of the internal permissions and privileges to the accessible services. | Groups, Users, Permissions, Restrictions, Environment | OS |
|6. OS Setup | Identification of the internal components and systems setup. | OS Type, Patch Level, Network config, OS Environment, Configuration files, sensitive private files | OS |

**OSINT sits within the Internet Presence layer**

#### Layer 1: Internet Presence

The "Internet Presence" layer is where we focus on finding the targets we can investigate. If the 
scope in the contract allows us to look for additional hosts, this layer is even more critical than 
for fixed targets only. In this layer, we use different techniques to find domains, subdomains, 
netblocks, and many other components and information that present the presence of the company and 
its infrastructure on the Internet.

**The goal of this layer is to identify all possible target systems and interfaces that can be tested.**

#### Layer 2: Gateway

Here we try to understand the interface of the reachable target, how it is protected, and where it 
is located in the network.

TODO: Link to other modules going into more detail

**The goal is to understand what we are dealing with and what we have to watch out for.**

#### Layer 3: Accessible Services

In the case of accessible services, we examine each destination for all the services it offers. 
Each of these services has a specific purpose that has been installed for a particular reason by 
the administrator. Each service has certain functions, which therefore also lead to specific 
results. To work effectively with them, we need to know how they work. Otherwise, we need to learn 
to understand them.

**This layer aims to understand the reason and functionality of the target system and gain the necessary knowledge to communicate with it and exploit it for our purposes effectively.**

#### Layer 4: Processes

Every time a command or function is executed, data is processed, whether entered by the user or 
generated by the system. This starts a process that has to perform specific tasks, and such tasks 
have at least one source and one target.

**The goal here is to understand these factors and identify the dependencies between them.**

#### Layer 5: Privileges

Each service runs through a specific user in a particular group with permissions and privileges 
defined by the administrator or the system. These privileges often provide us with functions that 
administrators overlook. This often happens in Active Directory infrastructures and many other 
case-specific administration environments and servers where users are responsible for multiple 
administration areas.

**It is crucial to identify these and understand what is and is not possible with these privileges.**

#### Layer 6: OS Setup

Here we collect information about the actual operating system and its setup using internal access. 
This gives us a good overview of the internal security of the systems and reflects the skills and 
capabilities of the company's administrative teams.

**The goal here is to see how the administrators manage the systems and what sensitive internal information we can glean from them.**

## Infrastructure Based Enumeration

### Enumeration Methodology in Practice

A methodology summarizes all systematic procedures in obtaining knowledge within the bounds of a 
given objective. It is important to note that a methodology is not a step-by-step guide but, as the 
definition implies, a summary of systematic procedures. In our case, the enumeration methodology is 
the systematic approach to explore a given target

### Domain Information

- Gather Domain Information passively through OSINT and third party services
- Investigate the company website and determine what services they offer
- Idenitfy technologies used to offer those services
- Familiarize ourself with the services
- Try to look at the services from a developer's point of view to gain technical insight into their 
functionality

#### Online Presence

- Look at SSL Certificates to find domains and subdomains
- Use crt.sh to find more subdomains ([Certificate transparency logs](https://en.wikipedia.org/wiki/Certificate_Transparency))
- Identify the hosts directly accessible from the internet and not hosted by third-party providers
(we may not test those hosts unless we have explicit permission of the third-party provider)

#### Certificate Transparency

Fetch logs for a domain:

```bash
domain="google.com"
curl -s "https://crt.sh/?q=$domain&output=json" | jq .
```

Filter them by unique subdomain:

```bash
domain="google.com"
curl -s "https://crt.sh/?q=$domain&output=json" | jq . | grep name | cut -d":" -f2 | grep -v "CN=" | cut -d'"' -f2 | awk '{gsub(/\\n/,"\n");}1;' | sort -u
```

#### Company Hosted Servers

Find company hosted servers:

```bash
for i in $(cat subdomainlist);do host $i | grep "has address" | grep $domain | cut -d" " -f1,4;done
```

#### Shodan - IP List

Find company hosted servers then run their IPs through Shodan:

```bash
for i in $(cat subdomainlist);do host $i | grep "has address" | grep $domain | cut -d" " -f4 >> ip-addresses.txt;done &&
for i in $(cat ip-addresses.txt);do shodan host $i;done
```

#### DNS Records

Get DNS records for a domain:

```bash
dig any $domain

# If any returns no results use the types one by one
type=("A" "MX" "NS" "TXT" "SOA")
for i in type;do dig $i $domain;done
```

- A records: More IP addresses
- MX records: Who/what manages company emails
- NS records: Name servers, identifying hosting provider
- TXT records: Third-party provider identification, [SPF](https://datatracker.ietf.org/doc/html/rfc7208), [DMARC](https://datatracker.ietf.org/doc/html/rfc7489) and [DKIM](https://datatracker.ietf.org/doc/html/rfc6376), MS values


### Cloud Resources

Use google dorking to find files in AWS S3 buckets and Azure blob storage

```
# S3 bucket
intext:<text-to-find> inurl:amazonaws.com

# Azure blob storage
intext:<text-to-find> inurl:blob.core.windows.net
```

Look at web page source code to find S3 buckets and Azure blob storage too

[Domain.Glass](https://domain.glass/) provides useful information on a company's infrastructure, 
including Cloudflare security assessments

[GrayHatWarfare](https://buckets.grayhatwarfare.com/) can be used to discover AWS, Azure and GCP 
could storage and filter and sort the contents

Look for sensitive files like ssh keys, certs, files containing passwords

### Staff

- Identify staff members on social media (LinkedIn, Xing)
- Look at job postings for information on the company's infrastructure
- Look at staff member's GitHub projects to see what they skills they showcase as they will likely 
use them at the company
- Look for technical employees on LinkedIn (development, security)

## Host Based Enumeration

### FTP

One of the oldest protocols on the Internet  
Runs on the application layer of the TCP/IP stack  

- port TCP/21 Control channel
- port TCP/20 Data channel
- active or passive mode

Not all commands are implemented on FTP servers, when a command is executed on the client the 
server responds with a status code
[Status codes](https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes)

#### TFTP

Does not provide authentication
Uses UDP instead of TCP
Relies on the file's read and write permissions to limit access
Does not have directory listing functionality

| Commands | Description |
|----------|-------------|
| connect | Sets the remote host and optionally the port for file transfers |
| get | Transfers a file or set of files from the remote host to the local host |
| put | Transfers a file or set of files from the local host to the remote host |
| quit | Quits |
| status | shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out values, etc. |
| verbose | Turns verbose mode on or off |

#### Default Configuration - vsFTPd

Most common ftp server is [vsFTPd](https://security.appspot.com/vsftpd.html) (pureFTP most common on shodan)
Not all settings are in the .conf file, [list here](http://vsftpd.beasts.org/vsftpd_conf.html)

**vsFTPd Config File**

```bash
# List active (uncommented) settings
cat /etc/vsftpd.conf | grep -v "#"
```

**FTPUSERS**

List of users denied access to the FTP service

```bash
cat /etc/ftpusers
```

**Dangerous Settings**

| Setting | Description |
|---------|-------------|
| anonymous_enable=YES | Allowing anonymous login? |
| anon_upload_enable=YES | Allowing anonymous to upload files? |
| anon_mkdir_write_enable=YES | Allowing anonymous to create new directories? |
| no_anon_password=YES | Do not ask anonymous for password? |
| anon_root=/home/username/ftp | Directory for anonymous. |
| write_enable=YES | Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE? |

**Anonymous Login**

Use username `anonymous` for anonymous access if it's enabled

**vsFTPd Status**

Show server status

```bash
ftp> status
```

**vsFTPd Detailed Output**

Use debug and trace for detailed information

```bash
ftp> debug

Debugging on (debug=1).


ftp> trace

Packet tracing on.


```

| Setting | Description |
|---------|-------------|
| dirmessage_enable=YES | Show a message when they first enter a new directory? |
| chown_uploads=YES | Change ownership of anonymously uploaded files? |
| chown_username=username | User who is given ownership of anonymously uploaded files. |
| local_enable=YES | Enable local users to login? |
| chroot_local_user=YES | Place local users into their home directory? |
| chroot_list_enable=YES | Use a list of local users that will be placed in their home directory? |


| Setting | Description |
|---------|-------------|
| hide_ids=YES | All user and group information in directory listings will be displayed as "ftp". |
| ls_recurse_enable=YES | Allows the use of recurse listings. |

**Hiding IDs - YES**

This setting is a security feature to prevent local usernames from being revealed. While usage of
[fail2ban](https://en.wikipedia.org/wiki/Fail2ban) solutions prevents us using these for a brute force attack it can still be useful information

**Recursive Listing**

```bash
ftp> ls -R
```

**Download a file**

```bash
ftp> get Notes.txt
```

**Download all available files**

```bash
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.2
```

**Upload a file**

```bash
ftp> put test.txt
```

#### Footprinting the Service - FTP

**Nmap FTP Scripts**

Find FTP scripts:

```bash
locate scripts/ftp
find / -type f -name ftp* 2>/dev/null | grep scripts
```

Script scan (Aggressive):

```bash
nmap -sV -sC -A -p21 10.10.10.1

# With script packet trace
nmap -sV -sC -A -p21 10.10.10.1 --script-trace
```

Service interaction:

```bash
nc -nv 10.10.10.1 21

telnet 10.10.10.1 21

# Use openssl for servers running TLS/SSL (also gives us the SSL cert)
openssl s_client -connect 10.10.10.1:21 -starttls ftp
```

### SMB

Client-server protocol regulating access to files, directories and other network resources  
TCP protocol used to establish initial connection and the transportation of data ([info](https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-SMB2/%5bMS-SMB2%5d.pdf#%5B%7B%22num%22%3A920%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C69%2C738%2C0%5D))  
Access rights are defined by Access Control Lists (ACL)  
**ACLs are defined based on the shares not the rights assigned locally on the server**

- ports 137, 138, 139 (NetBIOS)
- port TCP/445 (SMB/CIFS)

#### Samba

Developed for Unix-based OS  
Implements Common Internet File System (CIFS)  
[CIFS](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cifs/934c2faa-54af-4526-ac74-6a24d126724e) is a very specific implementation of the SMB protocol  

| SMB Version | Supported | Features |
|-------------|-----------|----------|
| CIFS | Windows NT 4.0 | Communication via NetBIOS interface |
| SMB 1.0 | Windows 2000 | Direct connection via TCP |
| SMB 2.0 | Windows Vista, Windows Server 2008 | Performance upgrades, improved message signing, caching feature |
| SMB 2.1 | Windows 7, Windows Server 2008 R2 | Locking mechanisms |
| SMB 3.0 | Windows 8, Windows Server 2012 | Multichannel connections, end-to-end encryption, remote storage access |
| SMB 3.0.2 | Windows 8.1, Windows Server 2012 R2 |  |
| SMB 3.1.1 | Windows 10, Windows Server 2016 | Integrity checking, AES-128 encryption |

In version 3 Samba server gained the ability to be a full member of an Active Directory domain.  
In version 4, Samba provides an Active Directory domain controller.  
[SMB server daemon](https://www.samba.org/samba/docs/current/man-html/smbd.8.html) (`smbd`) provides filesharing and printing services to clients  
[NetBIOS message block daemon](https://www.samba.org/samba/docs/current/man-html/nmbd.8.html) (`nmbd`) provides NetBIOS over IP naming services to clients  

Workgroups are group names that identify an arbitrary collection of computers and their resources 
on an SMB network. Machines need a name in a NetBIOS environment, which is done through the name 
registration procedure. Either each host reserves it's hostname on the network or the NetBIOS Name 
Server (NBNS) is used to assign them (Windows implementation of NBNS is [WINS](https://networkencyclopedia.com/windows-internet-name-service-wins/))

#### Default Configuration - Samba

Samba offers a wide range of [settings](https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html) that we can define in a text file (`/etc/samba/smb.conf`)

Filtered settings: `cat /etc/samba/smb.conf | grep -v '#\|\;`

Shares are defined with `[share-name]` and contain settings for that share, these settings override 
global settings

Example settings:

| Setting | Description |
|---------|-------------|
| [sharename] | The name of the network share. |
| workgroup = WORKGROUP/DOMAIN | Workgroup that will appear when clients query. |
| path = /path/here/ | The directory to which user is to be given access. |
| server string = STRING | The string that will show up when a connection is initiated. |
| unix password sync = yes | Synchronize the UNIX password with the SMB password? |
| usershare allow guests = yes | Allow non-authenticated users to access defined share? |
| map to guest = bad user | What to do when a user login request doesn't match a valid UNIX user? |
| browseable = yes | Should this share be shown in the list of available shares? |
| guest ok = yes | Allow connecting to the service without using a password? |
| read only = yes | Allow users to read files only? |
| create mask = 0700 | What permissions need to be set for newly created files? |

#### Dangerous Settings - SMB

| Setting | Description |
|--------|--------------|
| browseable = yes | Allow listing available shares in the current share? |
| read only = no | Forbid the creation and modification of files? |
| writable = yes | Allow users to create and modify files? |
| guest ok = yes | Allow connecting to the service without using a password? |
| enable privileges = yes | Honor privileges assigned to specific SID? |
| create mask = 0777 | What permissions must be assigned to the newly created files? |
| directory mask = 0777 | What permissions must be assigned to the newly created directories? |
| logon script = script.sh | What script needs to be executed on the user's login? |
| magic script = script.sh | Which script should be executed when the script gets closed? |
| magic output = script.out | Where the output of the magic script needs to be stored? |

#### Example Share

```
...SNIP...

[notes]
	comment = CheckIT
	path = /mnt/notes/

	browseable = yes
	read only = no
	writable = yes
	guest ok = yes

	enable privileges = yes
	create mask = 0777
	directory mask = 0777
```

After adding a share restart samba

`systemctl restart smbd`

#### Footprinting the Service - SMB

Nmap scan targeting SMB and NetBIOS ports

```bash
sudo nmap 10.10.10.2 -sC -sV -p139,445
```

Nmap results are limited so it's a good idea to manually interact with the service 
using other tools like `rpcclient`, which is used to perform MS-RPC functions.

The [Remote Procedure Call](https://www.geeksforgeeks.org/remote-procedure-call-rpc-in-operating-system/) (RPC) is a concept and also a central tool to realize 
operational and work-sharing structures in networks and client-server architectures.
The communication process via RPC includes passing parameters and the return of a 
function value.

```bash
rpcclient -U "" 10.10.10.2
```

#### RPCclient

Example queries that the RPCclient implements (full list in [man page](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html))

| Query | Description |
|-------|-------------|
| srvinfo | Server information. |
| enumdomains | Enumerate all domains that are deployed in the network. |
| querydominfo | Provides domain, server, and user information of deployed domains. |
| netshareenumall | Enumerates all available shares. |
| netsharegetinfo <share> | Provides information about a specific share. |
| enumdomusers | Enumerates all domain users. |
| queryuser <RID> | Provides information about a specific user. |

An anonymous user can access a surprising amount of information using rpcclient if 
anonymous access is enabled, allowing us to discover other users and their groups

Script to gather User & Group RIDs:

```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

#### Other Tools

Alternatively we can use [Impacket](https://github.com/SecureAuthCorp/impacket)'s [samrdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py)

We can use other tools like [SMBMap](https://github.com/ShawnDEvans/smbmap), [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec), and [Enum4linux](https://github.com/cddmp/enum4linux-ng) to gather information

```bash
# smbmap (currently not working v1.10.4)
smbmap -H 10.10.10.2

# crackmapexec
crackmapexec smb 10.10.10.2 --shares -u '' -p ''

# Enum4linux
enum4linux 10.10.10.2 -A
```

We need to use more than 1 or 2 tools for enumeration, different tools may give us new information 
or clues for next steps. Also don't rely on automated tools, manual enumeration is very important!

### NFS

Same purpose as SMB, network accessible file systems. Uses [NFS protocol](https://en.wikipedia.org/wiki/Network_File_System).  
Based on the [Open Network Computing Remote Procedure Call (ONC-RPC/SUN-RPC)](https://en.wikipedia.org/wiki/Sun_RPC) protocol exposed on TCP and UDP ports 111,
which uses [External Data Representation](https://en.wikipedia.org/wiki/External_Data_Representation) (XDR) for system-independant exchange of data.  
The NFS protocol has no mechanism for authN or authZ 
TODO: more info on authN (RPC's role, UIDs/GIDs)

| Version | Features | RFC |
|---------|----------|-----|
| NFSv2 | Older but still supported by many systems and was initially operated entirely over UDP. | [RFC 1094](https://datatracker.ietf.org/doc/html/rfc1094) |
| NFSv3 | More features, including variable file size and better error reporting, not fully compatible with NFSv2 clients. | [RFC 1813](https://datatracker.ietf.org/doc/html/rfc1813) |
| NFSv4 | Includes Kerberos, works through firewalls and on the Internet, no longer requires portmappers, supports ACLs, applies state-based operations, and provides performance improvements and high security. First version to have a stateful protocol. | [RFC 3530](https://www.rfc-editor.org/rfc/rfc3530) |
| NFSv4.1 | Aims to provide protocol support to leverage cluster server deployments, the ability to provide scalable parallel access to files distributed across multiple servers (pNFS extension), adn a session trunking mechanism, aka NFS multipathing | [RFC 8881](https://datatracker.ietf.org/doc/html/rfc8881)

#### Default Configuration - NFS

Configuration is stored in `/etc/exports`, the [NFS Exports Table](http://manpages.ubuntu.com/manpages/trusty/man5/exports.5.html) shows available options

#### Dangerous Settings - NFS

| Option | Description |
|--------|-------------|
| rw | Read and write permissions. We can create users with the same UID/GID to edit existing files if this is enabled |
| insecure | Ports above 1024 will be used. |
| nohide | If another file system was mounted below an exported directory, this directory is exported by its own exports entry. |
| no_root_squash | All files created by root are kept with the UID/GID 0. |

#### Footprinting the Service - NFS

Nmap

```bash
# Service discovery on NFS ports 111 and 2049
sudo nmap 10.10.10.2 -p111,2049 -sC -sV

# rpcinfo script to find running RPC services
sudo nmap 10.10.10.2 -p111 --script rpcinfo

# All NFS scripts (share contents and stats)
sudo nmap 10.10.10.2 -p111,2049 --script nfs* -sV
```

### DNS

Mainly unencrypted, encryption solutions available are DNS over TLS (DoT), DNS over HTTPS (DoH) and 
the DNSCrypt protocol

DNS servers:

| Server Type | Description |
|-------------|-------------|
| DNS Root Server | The root servers of the DNS are responsible for the top-level domains (TLD). As the last instance, they are only requested if the name server does not respond. Thus, a root server is a central interface between users and content on the Internet, as it links domain and IP address. The [Internet Corporation for Assigned Names and Numbers](https://www.icann.org/) (ICANN) coordinates the work of the root name servers. There are 13 such root servers around the globe. |
| Authoritative Nameserver | Authoritative name servers hold authority for a particular zone. They only answer queries from their area of responsibility, and their information is binding. If an authoritative name server cannot answer a client's query, the root name server takes over at that point. |
| Non-authoritative Nameserver | Non-authoritative name servers are not responsible for a particular DNS zone. Instead, they collect information on specific DNS zones themselves, which is done using recursive or iterative DNS querying. |
| Caching DNS Server | Caching DNS servers cache information from other name servers for a specified period. The authoritative name server determines the duration of this storage. |
| Forwarding Server | Forwarding servers perform only one function: they forward DNS queries to another DNS server. |
| Resolver | Resolvers are not authoritative DNS servers but perform name resolution locally in the computer or router. |

DNS Records:

| DNS Record | Description |
|------------|-------------|
| A | Returns an IPv4 address of the requested domain as a result. |
| AAAA | Returns an IPv6 address of the requested domain. |
| MX | Returns the responsible mail servers as a result. |
| NS | Returns the DNS servers (nameservers) of the domain. |
| TXT | This record can contain various information. The all-rounder can be used, e.g., to validate the Google Search Console or validate SSL certificates. In addition, SPF and DMARC entries are set to validate mail traffic and protect it from spam. |
| CNAME | This record serves as an alias for another domain name. If you want the domain www.hackthebox.eu to point to the same IP as hackthebox.eu, you would create an A record for hackthebox.eu and a CNAME record for www.hackthebox.eu. |
| PTR | The PTR record works the other way around (reverse lookup). It converts IP addresses into valid domain names. |
| SOA | Provides information about the corresponding DNS zone and email address of the administrative contact. |

#### Default Configuration - DNS

All DNS servers work with three different types of configuration files:

1. Local DNS config files
2. Zone files
3. Reverse name resolution files

[Bind9](https://www.isc.org/bind/) is a DNS server commonly used on Linux-based distros. Local
config files are usually:

- `named.conf.local`
- `named.conf.options`
- `named.conf.log`

`named.conf` is divided into several options, `global options` affect all zones and `zone options` 
only affects the zone it is applied to. Options not listed in `named.conf` have default values 
applied.

If an option is global and zone then the zone option takes precedence

[Bind9 documentation](https://wiki.debian.org/Bind9)

#### Local DNS Configuration

```bash
# example zone definition in named.conf.local
root@bind9:~ cat /etc/bind/named.conf.local

//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";
zone "domain.com" {
    type master;
    file "/etc/bind/db.domain.com";
    allow-update { key rndc-key; };
};
```

Defined zones are divided into indivdual files (`/etc/bind/db.domain.com` in the example)


#### Zone Files

Zone files describe a DNS zone in the BIND file format. There must be only one `SOA` record and at 
least one `NS` record. A syntax error usually means the entire zone file file is unusable. The name 
server will behave as if the zone does not exist, responding to DNS queries with a `SERVFAIL` error 
message. All `forward records` are entered here.

```bash
# example zone file
root@bind9:~ cat /etc/bind/db.domain.com

;
; BIND reverse data file for local loopback interface
;
$ORIGIN domain.com
$TTL 86400
@     IN     SOA    dns1.domain.com.     hostmaster.domain.com. (
                    2001062501 ; serial
                    21600      ; refresh after 6 hours
                    3600       ; retry after 1 hour
                    604800     ; expire after 1 week
                    86400 )    ; minimum TTL of 1 day

      IN     NS     ns1.domain.com.
      IN     NS     ns2.domain.com.

      IN     MX     10     mx.domain.com.
      IN     MX     20     mx2.domain.com.

             IN     A       10.129.14.5

server1      IN     A       10.129.14.5
server2      IN     A       10.129.14.7
ns1          IN     A       10.129.14.2
ns2          IN     A       10.129.14.3

ftp          IN     CNAME   server1
mx           IN     CNAME   server1
mx2          IN     CNAME   server2
www          IN     CNAME   server2
```

#### Reverse Name Resolution Files

To resolve the IP address from the Fully Qualified Domain Name (FQDN) the DNS server must have a 
reverse lookup file, the FQDN is assigned to the last octet of an IP address (corresponding to the 
host) using a `PTR` record

```bash
# example reverse name resolution file
# server1.domain.com resolves to 10.129.14.5
root@bind9:~ cat /etc/bind/db.10.129.14

;
; BIND reverse data file for local loopback interface
;
$ORIGIN 14.129.10.in-addr.arpa
$TTL 86400
@     IN     SOA    dns1.domain.com.     hostmaster.domain.com. (
                    2001062501 ; serial
                    21600      ; refresh after 6 hours
                    3600       ; retry after 1 hour
                    604800     ; expire after 1 week
                    86400 )    ; minimum TTL of 1 day

      IN     NS     ns1.domain.com.
      IN     NS     ns2.domain.com.

5    IN     PTR    server1.domain.com.
7    IN     MX     mx.domain.com.
...SNIP...
```

#### Dangerous Settings - DNS

List of vulnerabilities targeting bind9 [here](https://www.cvedetails.com/product/144/ISC-Bind.html?vendor_id=64)

[Popular DNS attacks](https://securitytrails.com/blog/most-popular-types-dns-attacks)

| Option | Description |
|--------|-------------|
| allow-query | Defines which hosts are allowed to send requests to the DNS server. |
| allow-recursion | Defines which hosts are allowed to send recursive requests to the DNS server. |
| allow-transfer | Defines which hosts are allowed to receive zone transfers from the DNS server. |
| zone-statistics | Collects statistical data of zones. |

#### Footprinting the Service - DNS

**NS query**

Find other name servers from the target DNS server:

```bash
dig NS example.com @10.10.10.4
```

**Version query**

Query the version of the DNS server using a class CHAOS query and type TXT:

```bash
dig CH TXT version.bind 10.10.10.4
```

**ANY query**

Use ANY to view all available records (not all entries from the zones will be shown!):

```bash
dig ANY example.com @10.10.10.4
```

**AXFR Zone Transfer**

Initiate a zone transfer for the domain giving us a copy of the zone from the primary server

```bash
dig AXFR example.com @10.10.10.4
```

**AXFR Zone Transfer - Internal**

```bash
dig AXFR internal.example.com @10.10.10.4
```

**Subdomain Brute-forcing**

Use a for loop to brute-force subdomains using a wordlist and `dig`

```bash
for sub in $(cat /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.example.com @10.10.10.4 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done
```

[DNSenum](https://github.com/fwaeytens/dnsenum) is another option

```bash
dnsenum --dnsserver 10.10.10.4 --enum -p 0 -s 0 -o subdomains.txt -f /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt example.com
```

### SMTP

- Simple Mail transfer Protocol (SMTP) is used to transmit emails  
- Often combined with IMAP or POP3 protocols which retrieve emails from a server  
- port TCP/25
- Can be used in conjuction with SSL/TLS encryption  
- Most modern SMTP servers support the protocol extension ESMTP with SMTP-Auth (authN, authZ)
- No usable delivery confirmation
- Email senders are not authenticated and are therefore unreliable
- Spam prevention identification protocols [DomainKeys (DKIM)](http://dkim.org/) and [Sender Policy Framework (SPF)](https://dmarcian.com/what-is-spf/)

Mail User Agent (MUA)  
Mail Submission Agent (MSA) aka Relay server  
Mail Transfer Agent (MTA)  
Mail Delivery Agent (MDA)

Client (MUA) -> Submission Agent (MSA) -> Open Relay (MTA) -> Mail Delivery Agent (MDA) -> Mailbox (POP3/IMAP)

ESMTP uses TLS, after sending `HELO/EHLO` use `STATTLS` to initialize an SSL-protected SMTP connection

#### Default Configuration - SMTP

SMTP Server commands:

| Command | Description |
|---------|-------------|
| AUTH PLAIN | AUTH is a service extension used to authenticate the client. |
| HELO | The client logs in with its computer name and thus starts the session. |
| MAIL FROM | The client names the email sender. |
| RCPT TO | The client names the email recipient. |
| DATA | The client initiates the transmission of the email. |
| RSET | The client aborts the initiated transmission but keeps the connection between client and server. |
| VRFY | The client checks if a mailbox is available for message transfer. |
| EXPN | The client also checks if a mailbox is available for messaging with this command. |
| NOOP | The client requests a response from the server to prevent disconnection due to time-out. |
| QUIT | The client terminates the session. |

Use telnet to interact with an SMTP server

```bash
telnet 10.10.10.2 25
```

We can then send commands to the server

```bash
Trying 10.10.10.2...
Connected to 10.10.10.2.
Escape character is '^]'.
220 ESMTP Server

HELO mail1.example.com

250 mail1.example.com

EHLO mail1

250-mail1.example.com
250-PIPELINING
250-SIZE 10240000
250-ETRN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-DSN
250-SMTPUTF8
250 CHUNKING
```

We can use `VRFY` to enumerate users. This does not always work as the SMTP server can be 
configured to respond with `code 252` for users that do not exist

Sometimes we may have to work through a web proxy. We can also make this web proxy connect to the 
SMTP server. The command that we would send would then look something like this:

`CONNECT 10.129.14.128:25 HTTP/1.0`

**Send an Email**

1. Connect with telnet
2. Send `HELO/EHLO domain`
3. Send `MAIL FROM: <user@domain>`
4. Send `RCPT TO: <user@domain> NOTIFY=success,failure`
5. Send `DATA`
6. Write email and finish with `.`

Email headers are available to the sender and the recipient and can contain valuable information

Email header structure defined in [RFC5322](https://datatracker.ietf.org/doc/html/rfc5322)

#### Dangerous Settings - SMTP

To prevent the sent emails from being filtered by spam filters and not reaching the recipient, the 
sender can use a relay server that the recipient trusts. It is an SMTP server that is known and 
verified by all others. As a rule, the sender must authenticate himself to the relay server before 
using it.

Often, administrators have no overview of which IP ranges they have to allow. They allow all IP 
addresses to not cause errors in the email traffic and to not disturb or unintentionally interrupt 
communication with potential and current customers.

**Open Relay configuration**

```
mynetworks = 0.0.0.0/0
```

This allows anybody with access to the SMTP server to send email through it ([Open mail relay](https://en.wikipedia.org/wiki/Open_mail_relay))


#### Footprinting the Service - SMTP

Nmap's default scripts include `smtp-commands` which uses the EHLO command to list all possible 
commands available to be executed on the SMTP server

```bash
sudo nmap 10.10.10.2 -sC -sV -p25
```

We can also use the `smtp-open-relay` script to determine if the target SMTP server is an open relay

```bash
sudo nmap 10.10.10.2 -p25 --script smtp-open-relay
```

### IMAP/POP3

**IMAP**

- IMAP allows online management of emails directly on the server  
- Client-server protocol
- Allows synchronization of a local email client with the mailbox on the server
- Text based commands in ASCII format
- port TCP/143
- port TCP/993 (TLS/SSL)

**POP3**

- Only provides listing, retireving and deleting emails as functions on the email server
- port TCP/110
- port TCP/995 (TLS/SSL)

#### Default Configuration - IMAP/POP3

Dovecot docs:
- [Core settings](https://doc.dovecot.org/settings/core/)
- [Service configuration](https://doc.dovecot.org/configuration_manual/service_configuration/)


**IMAP Commands**

Extensive list here https://www.atmail.com/blog/imap-commands/

| Command | Description |
|---------|-------------|
| `a LOGIN username password` | User's login. |
| `a LIST "" *` | Lists all directories. |
| `a CREATE "INBOX"` | Creates a mailbox with a specified name. |
| `a DELETE "INBOX"` | Deletes a mailbox. |
| `a RENAME "ToRead" "Important"` | Renames a mailbox. |
| `a LSUB "" *` | Returns a subset of names from the set of names that the User has declared as being active or subscribed. |
| `a SELECT INBOX` | Selects a mailbox so that messages in the mailbox can be accessed. |
| `a UNSELECT INBOX` | Exits the selected mailbox. |
| `a FETCH <ID(:ID)> all` | Retrieves data associated with a message in the mailbox. |
| `a FETCH <ID(:ID)> full` | Like `all` but with data associated to the BODY as well |
| `a FETCH <ID(:ID)> (UID BODY[TEXT])` | Read message body text |
| `a FETCH <ID(:ID)> (BODY[HEADER.FIELDS (<Subject/To/From>)])` | Read message Subject/To/From etc. |
| `a CLOSE` | Removes all messages with the Deleted flag set. |
| `a LOGOUT` | Closes the connection with the IMAP server. |

**POP3 Commands**

| Command | Description |
|---------|-------------|
| USER username | Identifies the user. |
| PASS password | Authentication of the user using its password. |
| STAT | Requests the number of saved emails from the server. |
| LIST | Requests from the server the number and size of all emails. |
| RETR id | Requests the server to deliver the requested email by ID. |
| DELE id | Requests the server to delete the requested email by ID. |
| CAPA | Requests the server to display the server capabilities. |
| RSET | Requests the server to reset the transmitted information. |
| QUIT | Closes the connection with the POP3 server. |

#### Dangerous Settings - IMAP/POP3

| Setting | Description |
|---------|-------------|
| auth_debug | Enables all authentication debug logging. |
| auth_debug_passwords | This setting adjusts log verbosity, the submitted passwords, and the scheme gets logged. |
| auth_verbose | Logs unsuccessful authentication attempts and their reasons. |
| auth_verbose_passwords | Passwords used for authentication are logged and can also be truncated. |
| auth_anonymous_username | This specifies the username to be used when logging in with the ANONYMOUS SASL mechanism. |

#### Footprinting the Service - IMAP/POP3

Default ports

POP3:
- port TCP/110
- port TCP/995 (TLS/SSL)

IMAP:
- port TCP/143
- port TCP/993 (TLS/SSL)

Use nmap script and service version scanning on POP3 and IMAP ports

```bash
sudo nmap 10.10.10.2 -sV -sC -p110,995,143,993
```

If we have credentials we can use curl to interact with the server

```bash
curl -k 'imaps://10.10.10.2' --user user:password -v
```

Use openssl or ncat to interact with IMAP/POP3 over SSL

```bash
openssl s_client -connect 10.10.10.2:pop3s
```

```bash
openssl c_client -connect 10.10.10.2:imaps
```

TODO: test out IMAP and POP3 using dovecot-imapd/dovecot-pop3d

### SNMP

Simple Network Management Protocol (SNMP)

- Created to monitor network devices
- Can handle confguration and change settings remotely
- Hardware includes routers, switches, servers, IoT devices
- Control commands over UDP port 161
- Traps (unrequested event notifications sent from the SNMP server) over UDP port 162
- Available SNMP objects require a unique address known to both the server and client

**MIB**

Management Information Base

- Independent format for storing device information
- Text file containing all queryable SNMP objects of a device in a tree hierarchy
- Contains at least one Object Identifier (OID)
- Provides information about the unique address, name, type, access rights and a description of the object
- Written in Abstract Syntax Notation One (ASN.1) based ASCII text format
- Do not contain data, explain where to find information and what it looks like

**OID**

Object Idenitifier (OID)

- Sequence of numbers that uniquely idenitfies each node
- Integers usually concatenated by dot notation
- Look up OIDs in the [Object Identifier Registry](https://www.alvestrand.no/objectid/)

**SNMPv1**

- No built-in authentication
- Does not support encryption

**SNMPv2**

- v2c uses community strings
- 64-bit counters
- No encryption

**SMNPv3**

- User password authentication
- Encryption via pre-shared key

**Community Strings**

Community strings are secure strings that grant access to portions of a device's management plane.
Usually split between public (read-only access) and private (read-write access)

#### Default Configuration - SNMP

[manpage](http://www.net-snmp.org/docs/man/snmpd.conf.html)

SNMP Daemon config

```bash
cat /etc/snmp/snmpd.conf | grep -v '#'
```

#### Dangerous Settings - SNMP

| Settings | Description |
|----------|-------------|
| `rwuser noauth` | Provides access to the full OID tree without authentication. |
| `rwcommunity <community string> <IPv4 address>` | Provides access to the full OID tree regardless of where the requests were sent from. |
| `rwcommunity6 <community string> <IPv6 address>` | Same access as with rwcommunity with the difference of using IPv6. |

#### Footprinting the Service - SNMP

**SNMPwalk**

`snmpwalk` is used to query OIDs

```bash
# -v version, -c community string
snmpwalk -v2c -c public 10.10.10.2
```

**OneSixtyOne**

`onesixtyone` can be used to bruteforce the names of community strings using wordlists

We can use [crunch](https://secf00tprint.github.io/blog/passwords/crunch/advanced/en) to create custom wordlists

```bash
onesixtyone -c /usr/share/seclists/Discovery/SNMP/snmp.txt 10.10.10.2
```

**Braa**

`braa` can be used to bruteforce individual OIDs after we find a community string

```bash
braa <community string>@10.10.10.2:.1.3.6.*
```

### MySQL

[SQL language intro](https://www.w3schools.com/sql/sql_intro.asp)

- client-server principle
- DBs usually stored with .sql file extension
- port TCP/3306

**MySQL Clients**

- retrieve and edit data using SQL
- public or internal network access

**MySQL Databases**

- LAMP (Linux, Apache, MySQL, PHP)/LEMP (Linux, Nginx, MySQL, PHP) stack
- Can contain a wide range of data

#### Default Configuration - MySQL

[MySQL Server configuration reference](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html)

```bash
cat /etc/mysql/mysql.conf.d/mysqld.cnf | grep -v '#'
```

#### Dangerous Settings - MySQL

Security relevant settings:

| Settings | Description |
|----------|-------------|
| `user` | Sets which user the MySQL service will run as. |
| `password` | Sets the password for the MySQL user. |
| `admin_address` | The IP address on which to listen for TCP/IP connections on the administrative network interface. |
| `debug` | This variable indicates the current debugging settings |
| `sql_warnings` | This variable controls whether single-row INSERT statements produce an information string if warnings occur. |
| `secure_file_priv` | This variable is used to limit the effect of data import and export operations. |

#### Footprinting the Service - MySQL

**Nmap**

```bash
sudo nmap -sC -sV -p3306 --script mysql* 10.10.10.1
```

Important databases are system schema (`sys`) and information schema (`information_schema`)

The table sys.host_summary can give us information about the target hosting the sql server

### MSSQL

- port TCP/1433

#### MSSQL Clients

[SQL Server Management Studio](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15) can be used on Windows devices to connect to and interact with MSSQL servers. Look for saved credentials!

Other clients:

- [mssql-cli](https://docs.microsoft.com/en-us/sql/tools/mssql-cli?view=sql-server-ver15)
- [SQL Server Powershell](https://docs.microsoft.com/en-us/sql/powershell/sql-server-powershell?view=sql-server-ver15)
- [HeidiSQL](https://www.heidisql.com/)
- [SQLPro](https://www.macsqlclient.com/)
- [Impacket's mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)

#### MSSQL Databases

Table source: https://docs.microsoft.com/en-us/sql/relational-databases/databases/system-databases?view=sql-server-ver15

| Default System Database | Description |
|-------------------------|-------------|
| master | Tracks all system information for an SQL server instance |
| model | Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database |
| msdb | The SQL Server Agent uses this database to schedule jobs & alerts |
| tempdb | Stores temporary objects |
| resource | Read-only database containing system objects included with SQL server |

#### Default Configuration - MSSQL

The SQL Service usually runs as `NT SERVICE\MSSQLSERVER`

**TODO: test if SQL Server 2019 enforces encryption**

With SQL Server 2022, Windows Authentication can be used to connect from the client side by 
default but SQL Server authN must be enabled in Properties -> Security -> Server authentication

#### Dangerous Settings - MSSQL

Look for the following:

- MSSQL clients not using encryption to connect to the MSSQL server
- The use of self-signed certificates when encryption is being used. It is possible to spoof
self-signed certificates
- The use of [named pipes](https://docs.microsoft.com/en-us/sql/tools/configuration-manager/named-pipes-properties?view=sql-server-ver15)
- Weak & default sa credentials. Admins may forget to disable this account (Disabled by default 
in SQL Server 2022)

#### Footprinting the Service - MSSQL

**Nmap scripts**

```bash
sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 10.10.10.2
```

**Metasploit - MSSQL Ping**

```bash
msfconsole -x 'use auxiliary/scanner/mssql/mssql_ping; set rhosts 10.10.10.2; run'
```

**Connect with mssqlclient.py**

```bash
# windows-auth will fail if not connected to a trusted domain (tested on MSSQL Server 2022)
python3 mssqlclient.py Administrator@10.10.10.2 -windows-auth
```

### Oracle TNS

The Oracle Transparent Network Substrate (TNS) server is a communication protocol that facilitates 
communication between Oracle databases and applications over networks.

- port TCP/1521
- supports TCP/IP, UDP, IPX/SPX, and AppleTalk
- can support multiple network interfaces and listening on specific IP addresses or all available 
network interfaces
- preferred solution for large complex databases in healthcare, finance, and retail

#### Default Configuration - Oracle TNS

- The listener only accepts connections from authorized hosts
- Encrypts communication between client and server with Oracle Net Services
- config files: `tnsnames.ora` and `listener.ora`, default location: `$ORACLE_HOME/network/admin`

**tnsnames.ora**

Client-side config file with a service definition for `orcl`

```txt
ORCL =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.129.11.102)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )
```

**listener.ora**

Server-side config file

```txt
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = PDB1)
      (ORACLE_HOME = C:\oracle\product\19.0.0\dbhome_1)
      (GLOBAL_DBNAME = PDB1)
      (SID_DIRECTORY_LIST =
        (SID_DIRECTORY =
          (DIRECTORY_TYPE = TNS_ADMIN)
          (DIRECTORY = C:\oracle\product\19.0.0\dbhome_1\network\admin)
        )
      )
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = orcl.inlanefreight.htb)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = C:\oracle
```

Oracle databases can be protected by using a PL/SQL Exclusion List (PlsqlExclusionList).

It is a user-created text file that needs to be placed in the $ORACLE_HOME/sqldeveloper directory,
and it contains the names of PL/SQL packages or types that should be excluded from execution.

It serves as a blacklist that cannot be accessed through the Oracle Application Server.

| Setting | Description |
|---------|-------------|
| DESCRIPTION | A descriptor that provides a name for the database and its connection type. |
| ADDRESS | The network address of the database, which includes the hostname and port number. |
| PROTOCOL | The network protocol used for communication with the server |
| PORT | The port number used for communication with the server |
| CONNECT_DATA | Specifies the attributes of the connection, such as the service name or SID, protocol, and database instance identifier. |
| INSTANCE_NAME | The name of the database instance the client wants to connect. |
| SERVICE_NAME | The name of the service that the client wants to connect to. |
| SERVER | The type of server used for the database connection, such as dedicated or shared. |
| USER | The username used to authenticate with the database server. |
| PASSWORD | The password used to authenticate with the database server. |
| SECURITY | The type of security for the connection. |
| VALIDATE_CERT | Whether to validate the certificate using SSL/TLS. |
| SSL_VERSION | The version of SSL/TLS to use for the connection. |
| CONNECT_TIMEOUT | The time limit in seconds for the client to establish a connection to the database. |
| RECEIVE_TIMEOUT | The time limit in seconds for the client to receive a response from the database. |
| SEND_TIMEOUT | The time limit in seconds for the client to send a request to the database. |
| SQLNET.EXPIRE_TIME | The time limit in seconds for the client to detect a connection has failed. |
| TRACE_LEVEL | The level of tracing for the database connection. |
| TRACE_DIRECTORY | The directory where the trace files are stored. |
| TRACE_FILE_NAME | The name of the trace file. |
| LOG_FILE | The file where the log information is stored. |

#### Footprinting the Service - Oracle TNS

**Oracle tools setup script**

Pulls Odat repo and installs necessary Oracle tools to run it

```bash
#!/bin/bash

sudo apt-get install libaio1 python3-dev alien -y
git clone https://github.com/quentinhardy/odat.git
cd odat/
git submodule init
git submodule update
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip
export LD_LIBRARY_PATH=instantclient_21_12:$LD_LIBRARY_PATH
export PATH=$LD_LIBRARY_PATH:$PATH
pip3 install cx_Oracle
sudo apt-get install python3-scapy -y
sudo pip3 install colorlog termcolor passlib python-libnmap
sudo apt-get install build-essential libgmp-dev -y
pip3 install pycryptodome
```

**Nmap**

```bash
# Why open here?
sudo nmap -p1521 -sV 10.10.10.1 --open
```

**Nmap - SID bruteforcing**

SIDs (System Identifiers) are unique names that identify database instances and are required to 
connect to an Oracle database

```bash
sudo nmap -p1521 -sV 10.10.10.1 --open --script oracle-sid-brute
```

**ODAT**

We can also use ODAT to bruteforce SIDs, enumerate the service, and find credentials

```bash
./odat.py all -s 10.10.10.1
```

**SQLPlus - Log In**

[SQLPlus Commands](https://docs.oracle.com/cd/E11882_01/server.112/e41085/sqlqraa001.htm#SQLQR985)

```bash
# <username>/<password>@<ip/hostname>/<SID>
sqlplus scott/tiger@10.10.10.1/XE

# as System Database Admin
sqlplus scott/tiger@10.10.10.1/XE as sysdba
```

**Oracle RDBMS**

```bash
# list all tables in current database
SQL> select table_name from all_tables;

# list user privileges
SQL> select * from user_role_privs;

# extract password hashes
SQL> select name, password from sys.user$;

# file upload with Odat
# try default web server directories
# linux /var/www/html
# Windows C:\inetpub\wwwroot
cat "this is a test" > test.txt
./odat.py utlfile -s 10.10.10.1 -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot test.txt ./test.txt
```

### IPMI

[Intelligent Platform Management Interface (IPMI)](https://www.thomas-krenn.com/en/wiki/IPMI_Basics) is a set of standardized specifications for hardware-based host management
systems used for system management and monitoring.

- port UDP/623

It acts as an autonomous subsystem and works independently of the host's BIOS, CPU, firmware, and
underlying operating system. IPMI provides sysadmins with the ability to manage and monitor
systems even if they are powered off or in an unresponsive state. It operates using a direct
network connection to the system's hardware and does not require access to the operating system
via a login shell. IPMI can also be used for remote upgrades to systems without requiring physical
access to the target host. IPMI is typically used in three ways:

- Before the OS has booted to modify BIOS settings
- When the host is fully powered down
- Access to a host after a system failure

When not being used for these tasks, IPMI can monitor a range of different things such as system
temperature, voltage, fan status, and power supplies. It can also be used for querying inventory
information, reviewing hardware logs, and alerting using SNMP. The host system can be powered off,
but the IPMI module requires a power source and a LAN connection to work correctly.

Systems using IPMI version 2.0 can be administered via serial over LAN, giving sysadmins the 
ability to view serial console output in band. To function, IPMI requires the following components:

- Baseboard Management Controller (BMC) - A micro-controller and essential component of an IPMI
- Intelligent Chassis Management Bus (ICMB) - An interface that permits communication from one
chassis to another
- Intelligent Platform Management Bus (IPMB) - extends the BMC
- IPMI Memory - stores things such as the system event log, repository store data, and more
- Communications Interfaces - local system interfaces, serial and LAN interfaces, ICMB and PCI
Management Bus


#### Footprinting the Service - IPMI

**Nmap**

```bash
sudo nmap -sU --script ipmi-version -p 623 10.10.10.1
```

**Metasploit version scan**

```bash
msf6 > use auxiliary/scanner/ipmi/ipmi_version
```

Default Passwords:

| Product | Username | Password |
|---------|----------|----------|
| Dell iDRAC | root | calvin |
| HP iLO | Administrator | random 8-char string `[A-Z0-9]` |
| Supermicro IPMI | ADMIN | ADMIN |

#### Dangerous Settings - IPMI

If default credentials do not work to access a BMC, we can exploit a [flaw in the RAKP protocol](http://fish2.com/ipmi/remote-pw-cracking.html)
in IPMI 2.0. During the authentication process, the server sends a salted SHA1 or MD5 hash of the
user's password to the client before authentication takes place. This can be leveraged to obtain
the password hash for ANY valid user account on the BMC.

We can then crack the hashes offline using `hashcat -m 7300`

**Metasploit dumping hashes**

```bash
msf6 > use auxiliary/scanner/ipmi/ipmi_dumphashes
```

### Linux Remote Management Protocols

#### SSH
