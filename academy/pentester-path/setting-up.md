# Setting Up

### Table of Contents
- [Organization](#organization)
	- [Bookmarks](#bookmarks)
	- [Password Manager](#password-manager)
	- [Updates and Automation](#updates-and-automation)
	- [Note Taking](#note-taking)
- [Virtualization](#virtualization)
- [Containers](#containers)
	- [Docker](#docker)
	- [Vagrant](#vagrant)
- [Linux](#linux)
	- [Penetration Testing Distros](#penetration-testing-distros)
	- [Linux VM](#linux-vm)
	- [Terminal Modification](#terminal-modification)
	- [Automation](#automation)
- [Windows](#windows)
	- [Windows VM](#windows-vm)
		- [Install PSWindowsUpdate Module](#install-pswindowsupdate-module)
		- [Install Chocolatey](#install-chocolatey)
		- [Security Configurations](#security-configurations)
		- [Test VMs](#test-vms)
- [Virtual Private Server](#virtual-private-server)
	- [VPS Providers](#vps-providers)
	- [VPS Setup](#vps-setup)
	- [VPS Hardening](#vps-hardening)
		- [SSH Hardening](#ssh-hardening)
		- [2FA](#2fa)

## Organization

Set up directory structure by OS:

```bash
tree .

.
└── Penetration-Testing
	│
	├── Pre-Engagement
	│       └── ...
    ├── Linux
    │   ├── Information-Gathering
    │   │   └── ...
    │   ├── Vulnerability-Assessment
    │   │   └── ...
    │   ├── Exploitation
    │   │   └── ...
    │   ├── Post-Exploitation
    │   │   └── ...
    │   └── Lateral-Movement
    │       └── ...
    ├── Windows
    │   ├── Information-Gathering
    │   │   └── ...
    │   ├── Vulnerability-Assessment
    │   │   └── ...
    │   ├── Exploitation
    │   │   └── ...
    │   ├── Post-Exploitation
    │   │   └── ...
    │   └── Lateral-Movement
    │       └── ...
    ├── Reporting
    │   └── ...
	└── Results
	    └── ...
```

According to penetration testing fields:

```bash
tree .

.
└── Penetration-Testing
	│
	├── Pre-Engagement
	│       └── ...
    ├── Network-Pentesting
	│       ├── Linux
	│       │   ├── Information-Gathering
	│		│   │   └── ...
	│       │   ├── Vulnerability-Assessment
    │       │   │	└── ...
    │       │	└── ...
    │       │    	└── ...
    │		├── Windows
    │ 		│   ├── Information-Gathering
    │		│   │   └── ...
    │		│   └── ...
    │       └── ...
    ├── WebApp-Pentesting
	│       └── ...
    ├── Social-Engineering
	│       └── ...
    ├── .......
	│       └── ...
    ├── Reporting
    │   └── ...
	└── Results
	    └── ...
```

### Bookmarks

Create a penetration test firefox account for add-ons and bookmarks (**no sensitive information shold be stored**)

### Password Manager

Use a password manager to store credentials that you will need on an engagement. Can also be used for 
encrypted storage of sensitive notes

### Updates and Automation

Make sure to update the components used in engagements before starting a new penetration test. Record all 
resources and their sources in a file. We can then automate this and store the script in our password manager

### Note Taking

5 main types of information to note:

1. Newly discovered information:

	IP addresses, usernames, passwords, source code, etc., anything identified and related to the engagement 
	and process

2. Ideas for further tests and processing:

	Write down everything we see that should be investigated. Good tools for this are [Notion](https://notion.so), [Obsidian](https://obsidian.md), and [Xmind](https://www.xmind.net)

3. Scan results:
	
	Keeping and organizing scan results is critical, use tools like [Ghostwriter](https://github.com/GhostManager/Ghostwriter) or [Pwndoc](https://github.com/pwndoc/pwndoc) to generate documentation

4. Logging:

	We can use `script` and `date` in bash to monitor what commands are executed, when they are executed, 
	and log	the information to a file

	Replace the `PS1` variable (`PROMPT` in `.zshrc`) in our `.bashrc` with the following to display the
	date and time:

	`PS1="\[\033[1;32m\]\342\224\200\$([[ \$(/opt/vpnbash.sh) == *\"10.\"* ]] && echo \"[\[\033[1;34m\]\$(/opt/vpnserver.sh)\[\033[1;32m\]]\342\224\200[\[\033[1;37m\]\$(/opt/vpnbash.sh)\[\033[1;32m\]]\342\224\200\")[\[\033[1;37m\]\u\[\033[01;32m\]@\[\033[01;34m\]\h\[\033[1;32m\]]\342\224\200[\[\033[1;37m\]\w\[\033[1;32m\]]\n\[\033[1;32m\]\342\224\224\342\224\200\342\224\200\342\225\274 [\[\e[01;33m\]$(date +%D-%r)\[\e[01;32m\]]\\$ \[\e[0m\]"`

	To start logging with `script` (linux):

	```bash
	# Start logging
	script <date>-<start-time>-<name>.log	
	# Stop logging
	exit
	```

	To start logging with `Start-Transcript` (Windows):

	```cmd
	// Start logging
	Start-Transcript -Path "C:\Pentesting\<date>-<start-time>-<name>.log`
	// Stop logging
	Stop-Transcript
	```

	Use `tee` and stdout redirection to log scan results in bash, and `Out-File` and stdout redirection in 
	Windows

5. Screenshots
	
	Take screenshots for proof of exploitation and results obtained, required for the PoC and our docs.
	[Flameshot](https://github.com/flameshot-org/flameshot) for screenshots and [Peek](https://github.com/phw/peek) for recording.


## Virtualization

VMWare Workstation Pro/Player or VirtualBox

## Containers

A container cannot be defined as a virtual machine but as an isolated group of processes running on a single 
host that corresponds to a complete application, including its configuration and dependencies.

### Docker

**Docker Installation:**

```bash
sudo apt update && sudo apt install docker.io -y
```

```cmd
IEX((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))
choco upgrade chocolatey
choco install docker-desktop
```

### Vagrant

[Vagrant](https://www.vagrantup.com/) is a tool that can create, configure and manage VMs or VM environments

**Vagrant installation:**

```bash
sudo apt update && sudo apt install virtualbox virtualbox-dkms vagrant -y
```

```cmd
IEX((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))
choco upgrade chocolatey
cinst virtualbox cyg-get vagrant
```

## Linux

### Penetration Testing Distros

- [ParrotOS](https://www.parrotsec.org/)
- [Kali](https://kali.org)
- [BlackArch](https://blackarch.org)
- [BackBox](https://linux.backbox.org/)

### Linux VM

- Encrypt the drive
- Take snapshot after fresh install
- Update the distro
- Install tools (curate a tools file, `sudo apt install $(cat tools.txt | tr "\n" " ") -y`)
- Clone github repos
- Take a snapshot after updates and tool installation
- Encrypt the VM (VMWare Workstation: VM settings -> Access Control)

### Terminal Modification

**Terminal emulators/multiplexers:**

- [Terminator](https://terminator-gtk3.readthedocs.io/en/latest/)
- [Guake](http://guake-project.org/)
- [iTerm2](https://iterm2.com/)
- [Terminology](https://www.enlightenment.org/docs/apps/terminology.md)
- [Tmux](https://github.com/tmux/tmux/wiki) - [Ippsec's intro to Tmux](https://youtu.be/Lqehvpe_djs)

We can modifiy our bash prompt easily with [The Bash Prompt Generator](https://bash-prompt-generator.org/)

Customise the desktop manager - [Reddit community](https://www.reddit.com/r/unixporn/)

### Automation

Automate any modifications into scripts then host on a VPS, we can then download and execute the scripts for 
an easy VM set up

## Windows

### Windows VM

[Windows 10 developer VM](https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/) - 90 day trial

- Install PSWindowsUpdate and update VM
- Install Chocolatey
- Add Defender path exclusions
- Install packages with chocolatey (python, git, wsl2, openssh, openvpn, etc.)
- Clone tool git repos

#### Install PSWindowsUpdate Module

Check execution policy:

`Get-ExecutionPolicy -List`

Set execution policy for the current process: (Admin Powershell)

`Set-ExecutionPolicy Unrestricted -Scope Process`

Install the module:

`Install-Module PSWindowsUpdate`

Update the VM:

```cmd
Import-Module PSWindowsUpdate
Install-WindowsUpdate -AccceptAll
Restart-Computer -Force
```

#### Install Chocolatey

[Chocolatey info page](https://docs.chocolatey.org/en-us/choco/commands/install)

Download and install Chocolatey: (Admin Powershell)

`Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))`

Upgrade Chocolatey:

`choco upgrade chocolatey -y`

Get info on a package:

`choco info <package>`

Install packages:

`choco install <package> <package>`

Windows packages to install:

- microsoft-windows-terminal
- WSL2

#### Security Configurations

Add exclusions for tool directories:

```cmd
Add-MpPreference -ExclusionPath "C:\Users\username\AppData\Local\Temp\chocolatey"
Add-MpPreference -ExclusionPath "C:\Users\username\Documents\git-repos"
Add-MpPreference -ExclusionPath "C:\Users\username\Documents\scripts"
```

#### Tool Install Automation

```cmd
# Choco build script

write-host "*** Initial app install for core tools and packages. ***"

write-host "*** Configuring chocolatey ***"
choco feature enable -n allowGlobalConfirmation

write-host "*** Beginning install, go grab a coffee. ***"
choco upgrade wsl2 python git vscode openssh openvpn netcat nmap wireshark burp-suite-free-edition heidisql sysinternals putty golang neo4j-community openjdk

write-host "*** Build complete, restoring GlobalConfirmation policy. ***"
choco feature disable -n allowGlobalConfirmation
```

When scripting with Chocolatey, the developers recommend a few rules to follow:

- always use choco or choco.exe as the command in your scripts. cup or cinst tends to misbehave when used in 
a script.
- when utilizing options like -n it is recommended that we use the extended option like --name.
- Do not use --force in scripts. It overrides Chocolatey's behavior.

#### Test VMs

Older versions of Windows:

- [Chocolatey community](https://community.chocolatey.org/)
- [MediaCreationTool.bat](https://gist.github.com/AveYo/c74dc774a8fb81a332b5d65613187b15)
- [Microsoft Windows and Office ISO Download Tool](https://www.heidoc.net/joomla/technology-science/microsoft/67-microsoft-windows-and-office-iso-download-tool%EF%BB%BF)
- [Rufus](https://rufus.ie/en_US/)

## Virtual Private Server

### VPS Providers

| Provider | Price | RAM | CPU Cores | Storage | Transfer/Bandwidth |
|----------|-------|-----|-----------|---------|--------------------|
| [Vultr](https://www.vultr.com/products/cloud-compute/) | $10/mo | 2GB | 1 CPU | 55 GB | 2 TB |
| [Linode](https://www.linode.com/pricing/) | $10/mo | 2GB | 1 CPU | 50 GB | 2 TB |
| [DigitalOcean](https://www.digitalocean.com/pricing) | $10/mo | 2GB | 1 CPU | 50 GB | 2 TB |
| [OneHostCloud](https://onehostcloud.hosting/) | $14.99/mo | 2GB | 1 CPU | 50 GB | 2 TB |

### VPS Setup

- Choose server (Cloud compute)
- Choose server location closest to us
- Choose server type (OS)
- Choose server size (performance)
- Additional features (Use IPv6)
- Generate SSH keys (`ssh-keygen -t rsa -b 4096 -f vps-ssh`)
- Insert pub key into control panel

SSH into the VPS with root credentials and add a non-root user:

```bash
adduser <username>
usermod -aG sudo <username>
su - <username>
```

Add public SSH key to user:

```bash
mkdir ~/.ssh
echo '<vps-ssh.pub>' > ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

Login with SSH key:

`ssh <username>@<vps-ip-addr> -i vps-ssh`

### VPS Hardening

Example precautions to take:

- Install Fail2ban
- Working only with SSH keys
- Reduce Idle timeout interval
- Disable passwords
- Disable x11 forwarding
- Use a different port
- Limit users' SSH access
- Disable root logins
- Use SSH proto 2
- Enable 2FA Authentication for SSH

*Test these settings in a VM first to avoid issues in the VPS!*

Fully update the system:

`sudo apt update && sudo apt full-upgrade -y && sudo apt autoremove -y && sudo apt autoclean -y`

#### SSH Hardening

Install `fail2ban`

Backup fail2ban config:

`sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.conf.bak`

Update /etc/fail2ban/jail.conf:

```bash
# [sshd]
enabled = true
bantime = 4w
maxretry = 3
```

Backup and edit OpenSSH config:

`sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak`

| Settings | Description |
|----------|-------------|
| LogLevel VERBOSE | Gives the verbosity level that is used when logging messages from SSH daemon. |
| PermitRootLogin no | Specifies whether root can log in using SSH. |
| MaxAuthTries 3 | Specifies the maximum number of authentication attempts permitted per connection. |
| MaxSessions 5 | Specifies the maximum number of open shell, login, or subsystem (e.g., SFTP) sessions allowed per network connection. |
| HostbasedAuthentication no | Specifies whether rhosts or /etc/hosts.equiv authentication together with successful public key client host authentication is allowed (host-based authentication). |
| PermitEmptyPasswords no | When password authentication is allowed, it specifies whether the server allows login to accounts with empty password strings. |
| ChallengeResponseAuthentication yes | Specifies whether challenge-response authentication is allowed. |
| UsePAM yes | Specifies if PAM modules should be used for authentification. |
| X11Forwarding no | Specifies whether X11 forwarding is permitted. |
| PrintMotd no | Specifies whether SSH daemon should print /etc/motd when a user logs in interactively. |
| ClientAliveInterval 600 | Sets a timeout interval in seconds, after which if no data has been received from the client, the SSH daemon will send a message through the encrypted channel to request a response from the client. |
| ClientAliveCountMax 0 | Sets the number of client alive messages which may be sent without SSH daemon receiving any messages back from the client. |
| AllowUsers `<username>` | This keyword can be followed by a list of user name patterns, separated by spaces. If specified, login is allowed only for user names that match one of the patterns. |
| Protocol 2 | Specifies the usage of the newer protocol which is more secure. |
| AuthenticationMethods publickey,keyboard-interactive | Specifies the authentication methods that must be successfully completed for a user to be granted access. |
| PasswordAuthentication no | Specifies whether password authentication is allowed. |

#### 2FA

Install the [Goole-Authenticator PAM Module](https://github.com/google/google-authenticator-libpam):

```bash
sudo apt install libpam-google-authenticator -y
google-authenticator
```

Scan the QR code with Google Authenticator app

Enter the OTP and save the emergency scratch codes (backup codes)

Configure Google-Authenticator (y,y,n,y)

2FA PAM Configuration:

```bash
sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.bak
sudo vim /etc/pam.d/sshd

# Comment out @include common-auth
#@include common-auth

....SNIP....

# Add these 2 lines at the bottom of the file
auth required pam_google_authenticator.so
auth required pam_permit.so
```

Edit /etc/ssh/ssh_config:

```bash
# Add these 2 lines at the bottom of the file
AuthenticationMethods publickey,keyboard-interactive
PasswordAuthentication no
```

Restart SSH server:

```bash
sudo service ssh restart
```

SCP our tools to the VPS:

```bash
scp -i <ssh-private-key> -r <directory to transfer> <username>@<IP/FQDN>:<path>
```
