# Network Enumeration with Nmap

## Table of Contents
- [Host Discovery](#host-discovery)
- [Host and Port Scanning](#host-and-port-scanning)
    - [Discovering open TCP ports](#discovering-open-tcp-ports)
    - [Filtered ports](#filtered-ports)
    - [Discovering open UDP ports](#discovering-open-udp-ports)
- [Saving the Results](#saving-the-results)
- [Service Enumeration](#service-enumeration)
- [Nmap Scripting Engine](#nmap-scripting-engine)
- [Performance](#performance)
- [Firewall and IDS/IPS Evasion](#firewall-and-idsips-evasion)

### Host Discovery

Nmap documentation on host scanning - https://nmap.org/book/host-discovery-strategies.html

Scan a network range:

`sudo nmap 10.129.2.0/24 -sn -oA tnet | grep for | cut -d" " -f5`

- `-sn` disables port scanning and automatically ping scans with ICMP echo requests (`-PE`)

Scan a list of hosts:

`sudo nmap -sn -oA tnet -iL hosts.txt | grep for | cut -d" " -f5`

Scan multiple IPs:

`sudo nmap -sn -oA tnet 10.129.2.18 10.129.2.19 10.129.2.20 | grep for | cut -d" " -f5`

Scan a range of IPs:

`sudo nmap -sn -oA tnet 10.129.2.18-20 | grep for | cut -d" " -f5`

Scan a single IP:

`sudo nmap -sn -oA tnet 10.129.2.18 | grep for | cut -d" " -f5`

Use `--packet-trace` to see the packets sent and received

`sudo nmap 10.129.2.18 -sn -oA host -PE --packet-trace`

Use `--reason` to display the reason for the scan result

`sudo nmap 10.129.2.18 -sn -oA host -PE --reason`

We can use the ICMP response TTL to determine the OS of the target, article [here](https://gbhackers.com/operating-systems-can-be-detected-using-ping-command/)

### Host and Port Scanning

Six states of a scanned port:

| State | Description |
|-------|-------------|
| open | A connection to the port has been established (TCP connections, UDP datagrams, SCTP associations) |
| closed | The packet received contained an RST flag (TCP) |
| filtered | No response received or an error code from the target |
| unfiltered | Only occurs in TCP-ACK scans, means the port is accessible but cannot determine if it is open or closed|
| open\|filtered | If we receive no response, indicates port may be protected by a packet filter or firewall |
| closed\|filtered | Only occurs in IP ID idle scans, indicates it was impossible to determine if the port is closed or filtered by a firewall |

#### Discovering open TCP ports

Scanning top 10 TCP ports:

`sudo nmap 10.129.2.80 --top-ports=10`

- `--top-ports=n` scan top n ports

Trace the packets on a closed port:

`sudo nmap 10.129.2.80 -p 21 --packet-trace -Pn -n --disable-arp-ping`

Use the following for a clear view of the SYN scan:

- `-Pn` disables ICMP echo requests
- `-n` disables DNS resolution
- `--disable-arp-ping` disables...arp ping!!!

| Flag | Full name |
|------|-----------|
| S | SYN |
| A | ACK |
| R | RST |

Closed packet trace:
```
sudo nmap 10.129.2.80 -p 21 --packet-trace -Pn -n --disable-arp-ping

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-01 15:40 IST
SENT (0.0464s) TCP 10.10.16.30:64446 > 10.129.2.80:21 S ttl=44 id=45731 iplen=44  seq=1557065458 win=1024 <mss 1460>
RCVD (0.0709s) TCP 10.129.2.80:21 > 10.10.16.30:64446 RA ttl=63 id=0 iplen=40  seq=0 win=0 
Nmap scan report for 10.129.2.80
Host is up (0.025s latency).

PORT   STATE  SERVICE
21/tcp closed ftp

Nmap done: 1 IP address (1 host up) scanned in 0.11 seconds
```

Open packet trace:
```
sudo nmap 10.129.2.80 -p 22 --packet-trace -Pn -n --disable-arp-ping

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-01 15:45 IST
SENT (0.0310s) TCP 10.10.16.30:45546 > 10.129.2.80:22 S ttl=49 id=19792 iplen=44  seq=1745403367 win=1024 <mss 1460>
RCVD (0.0588s) TCP 10.129.2.80:22 > 10.10.16.30:45546 SA ttl=63 id=0 iplen=44  seq=2781844885 win=64240 <mss 1338>
Nmap scan report for 10.129.2.80
Host is up (0.028s latency).

PORT   STATE SERVICE
22/tcp open  ssh

Nmap done: 1 IP address (1 host up) scanned in 0.09 seconds
```

Connect scan:

TCP connect scan `-sT`, uses TCP three-way handshake

- The most accurate and stealthy way to determine a port's state, and more polite as it leaves no 
unfinished connections
- Less likely to be detected by IDS or IPS
- Can bypass firewalls that drop incoming but allow outgoing packets
- Takes longer

```
sudo nmap -sT 10.129.2.80 -p 445 --packet-trace -Pn -n --disable-arp-ping --reason

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-01 16:00 IST
CONN (0.0165s) TCP localhost > 10.129.2.80:445 => Operation now in progress
CONN (0.0433s) TCP localhost > 10.129.2.80:445 => Connected
Nmap scan report for 10.129.2.80
Host is up, received user-set (0.027s latency).

PORT    STATE SERVICE      REASON
445/tcp open  microsoft-ds syn-ack

Nmap done: 1 IP address (1 host up) scanned in 0.04 seconds
```

#### Filtered Ports

Firewalls can either drop or reject a packet, when a packet is dropped nmap receives no response.
Nmap has a default retry rate of 1 (`--max-retries`), if a packet was dropped it will send another

Check if packet was dropped:

```
sudo nmap 10.129.2.28 -p 139 --packet-trace -n --disable-arp-ping -Pn

Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-15 15:45 CEST
SENT (0.0381s) TCP 10.10.14.2:60277 > 10.129.2.28:139 S ttl=47 id=14523 iplen=44  seq=4175236769 win=1024 <mss 1460>
SENT (1.0411s) TCP 10.10.14.2:60278 > 10.129.2.28:139 S ttl=45 id=7372 iplen=44  seq=4175171232 win=1024 <mss 1460>
Nmap scan report for 10.129.2.28
Host is up.

PORT    STATE    SERVICE
139/tcp filtered netbios-ssn
MAC Address: DE:AD:00:00:BE:EF (Intel Corporate)

Nmap done: 1 IP address (1 host up) scanned in 2.06 seconds
```

Two packets with the SYN flag set were sent with no response indicating they were dropped

Check if packet was rejected:

```
sudo nmap 10.129.2.28 -p 445 --packet-trace -n --disable-arp-ping -Pn

Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-15 15:55 CEST
SENT (0.0388s) TCP 10.129.2.28:52472 > 10.129.2.28:445 S ttl=49 id=21763 iplen=44  seq=1418633433 win=1024 <mss 1460>
RCVD (0.0487s) ICMP [10.129.2.28 > 10.129.2.28 Port 445 unreachable (type=3/code=3) ] IP [ttl=64 id=20998 iplen=72 ]
Nmap scan report for 10.129.2.28
Host is up (0.0099s latency).

PORT    STATE    SERVICE
445/tcp filtered microsoft-ds
MAC Address: DE:AD:00:00:BE:EF (Intel Corporate)

Nmap done: 1 IP address (1 host up) scanned in 0.05 seconds
```

Here we received an ICMP reply of type 3 and error code 3, indicating the port is unreachable and 
that a firewall may be rejecting our packets

#### Discovering open UDP ports

UDP scan:

`sudo nmap 10.129.10.12 -sU -F`

`-sU` is a UDP scan and `-F` performs a fast scan on the top 100 ports

UDP scanning is much slower and we will only find open UDP ports if the application is configured to
respond. If we get an ICMP response of type 3 error code 3 then we know the port is closed, all 
other ICMP responses mark the port as open|filtered

We can use the `-sV` tag to perform a version scan on UDP ports as well

### Saving the Results

- Normal output with .nmap ext: `-oN`
- Greppable output with .gnmap ext: `-oG`
- XML output with .xml ext: `-oX`
- All output types: `-oA`

We can use the XML output to create easy to read HTML reports

`xsltproc target.xml -o target.html`

### Service Enumeration

**Service Version Detection**

Perform a full port scan first then use service enumeration on the discovered ports to improve speed
and reduce unnecessary traffic.

**Banner Grabbing**

Use `tcpdump` and `--packet-trace` to look for banners sent from the scanned service or
`nc -nv 10.10.10.1 22` as nmap doesn't always know how to handle the information received

### Nmap Scripting Engine

The NSE uses Lua and divides scripts into 14 categories

| Category | Description |
|----------|-------------|
| auth | Determination of authentication credentials. |
| broadcast | Scripts, which are used for host discovery by broadcasting and the discovered hosts, can be automatically added to the remaining scans. |
| brute | Executes scripts that try to log in to the respective service by brute-forcing with credentials. |
| default | Default scripts executed by using the `-sC` option. |
| discovery | Evaluation of accessible services. |
| dos | These scripts are used to check services for denial of service vulnerabilities and are used less as it harms the services. |
| exploit | This category of scripts tries to exploit known vulnerabilities for the scanned port. |
| external | Scripts that use external services for further processing. |
| fuzzer | This uses scripts to identify vulnerabilities and unexpected packet handling by sending different fields, which can take much time. |
| intrusive | Intrusive scripts that could negatively affect the target system. |
| malware | Checks if some malware infects the target system. |
| safe | Defensive scripts that do not perform intrusive and destructive access. |
| version | Extension for service detection. |
| vuln | Identification of specific vulnerabilities. |

### Performance

How fast `-T <0-5>`  
How frequent `--min-parallelism <number>`  
Timeout `--max-rtt-timeout <time>`  
How many simultaneous packets `--min-rate <number>`
Number of retries `--max-retries <number>`  

**Timeouts**

RTT == round-trip-time

Nmap starts with a high min timeout (100ms) which can increase scan times for larger networks, we 
can set a lower initial rtt timeout and limit the max rtt timeout e.g

```
nmap 10.129.10.0/24 --initial-rtt-timeout 50ms --max-rtt-timeout 100ms
```

**Max Retries**

Default max retries is set to 10, we can accelerate the scan by reducing max retries but the 
results may be less accurate

**Rates**

We can increase the minimum rate for sending packets to speed up our scans if we know the network 
bandwidth can handle it

`--min-rate <number`

**Timing**

We can use timing templates to set the aggressinveness of our scans, deafult is `-T 3`

`-T 0` | paranoid  
`-T 1` | sneaky  
`-T 2` | Polite  
`-T 3` | normal  
`-T 4` | aggressive  
`-T 5` | insane  

### Firewall and IDS/IPS Evasion

- Packet fragmentation
- Decoys

**Determine Firewall rules**

Dropped packets are ignored and no response is returned, rejected packets are returned with the RST 
flag and can contain ICMP error messages or nothing at all

Errors:

- Net Unreachable
- Net Prohibited
- Host Unreachable
- Host Prohibited
- Port Unreachable
- Proto Unreachable

The TCP ACK scan (-sA) method is much harder to filter for firewalls and IDS/IPS systems than 
regular SYN (-sS) or Connect scans (sT) because they only send a TCP packet with only the ACK flag.
When a port is closed or open, the host must respond with an RST flag.

Packets with the ACK flag are often passed by the firewall because the firewall cannot determine 
whether the connection was first established from the external network or the internal network.

**Detect IDS/IPS**

IDS systems examine all conections between hosts and notifies admins if it finds suspicious packets,
they help admins detect potential attacks

IPS systems will act independently to prevent attacks based on the configuration set by the admin,
they serve as a complement to IDS systems

Use multiple VPS with different IP addresses to trigger the monitoring applications and switch if 
they become blocked

**Decoys**

Use a comma-separated list of live IPs (including yours) as decoys or generate random IPs. Decoys 
should be live to prevent SYN flooding the target or triggering SYN flood security mechanisms.
Place your IP in 6th position or later as some common port scan detectors are unlikely to show your 
IP at all. If you don't use `ME` your position will be randomly assigned

`-D 10.10.1.20,10.10.1.3,10.10.1.7,10.10.1.221,10.10.1.22,ME,10.10.1.16`  

Generate 5 random IP addresses as decoys:

`-D RDM:5`

We can also use a different source IP to see if we get better results (e.g packets from a certain
subnet are dropped) using `-S <IP>`. The `-e <interface>` and `-Pn` options are required

**DNS Proxying**

We can specify DNS servers (`--dns-server <ns>,<ns>`) for Nmaps rDNS (IP -> domain name), allowing 
us to use the target company's DNS servers (the company DNS server's are more likely to be trusted 
than ones from the internet).

We can also set the source port (`--source-port <port>`) for our scans. Due to IPv6 and DNSSEC 
expansions, TCP port 53 is used more and more for DNS requests and using it as the source port 
could allow our packets to be trusted (if the admin uses the firewall to control this port and does 
not filter IDS/IPS properly)


